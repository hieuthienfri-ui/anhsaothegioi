<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Thi√™n Gi·ªõi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --n-red: #ff3131; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        #top-bar { position: absolute; top: 20px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .info-box { background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 15px; border: 2px solid var(--n-blue); box-shadow: 0 0 10px var(--n-blue); }
        .id-text { color: var(--n-pink); font-size: 12px; font-weight: bold; text-shadow: 0 0 5px var(--n-pink); margin-top: 5px; }
        .top-right-btns { display: flex; gap: 10px; align-items: center; }
        #code-btn { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; cursor: pointer; border: 2px solid var(--n-gold); color: var(--n-gold); background: #000; box-shadow: 0 0 10px var(--n-gold); text-transform: uppercase; }
        #music-toggle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 3px solid var(--n-red); color: var(--n-red); box-shadow: 0 0 15px var(--n-red); background: #000; transition: 0.3s; }
        #music-toggle.on { border-color: var(--n-green); color: var(--n-green); box-shadow: 0 0 15px var(--n-green); }
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rank-name { font-size: 60px; font-weight: 900; color: var(--n-pink); text-shadow: 0 0 30px var(--n-pink); margin: 0; }
        .btn-start { padding: 20px 60px; border-radius: 50px; background: #000; border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 26px; cursor: pointer; margin-top: 30px; box-shadow: 0 0 20px var(--n-green); }
        #bottom-bar { position: absolute; bottom: 30px; width: 100%; display: flex; gap: 15px; justify-content: center; padding: 0 20px; box-sizing: border-box; }
        .btn-large { flex: 1; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 20px; background: #000; border: 3px solid var(--n-blue); color: var(--n-blue); font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: 0 0 10px var(--n-blue); text-transform: uppercase; text-align: center; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-box { width: 85%; max-width: 350px; background: #000; border: 3px solid var(--n-pink); border-radius: 30px; padding: 25px; text-align: center; box-shadow: 0 0 40px var(--n-pink); }
        .btn-close { width: 100%; padding: 15px; background: var(--n-blue); color: #000; border: none; border-radius: 15px; font-weight: 900; font-size: 18px; margin-top: 20px; }
        #login-screen { position: fixed; inset: 0; z-index: 4000; background: #000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 80%; max-width: 320px; padding: 30px; border: 3px solid var(--n-blue); border-radius: 25px; text-align: center; }
        .login-box input { width: 100%; padding: 15px; margin: 15px 0; background: #111; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 18px; box-sizing: border-box; }
        .code-input { width: 90%; padding: 15px; background: #111; border: 2px dashed var(--n-gold); color: var(--n-gold); border-radius: 15px; font-size: 20px; text-align: center; margin: 15px 0; outline: none; }
    </style>
</head>
<body>
    <div id="login-screen"><div class="login-box"><h1 style="color:var(--n-blue); margin:0">THI√äN GI·ªöI</h1><input type="text" id="reg-user" placeholder="T√™n ƒê·∫°i ƒê·∫ø..."><button class="btn-large" style="width:100%" onclick="doLogin()">X√ÅC NH·∫¨N</button></div></div>
    <div id="msg-modal" class="modal"><div class="modal-box"><h2 id="msg-title" style="margin-top:0"></h2><div id="msg-body" style="font-size: 16px; line-height: 1.6; max-height: 300px; overflow-y: auto;"></div><button class="btn-close" onclick="closeMsg()">ƒê√É HI·ªÇU</button></div></div>
    <div id="code-modal" class="modal"><div class="modal-box" style="border-color: var(--n-gold);"><h2 style="color: var(--n-gold); margin-top:0">THI√äN M√É L·ªÜNH</h2><input type="text" id="input-code-val" class="code-input" placeholder="NH·∫¨P M√É..."><button class="btn-large" style="width:100%; border-color: var(--n-gold); color: var(--n-gold);" onclick="submitCode()">K√çCH HO·∫†T</button><button class="btn-close" style="background: #222; color: #fff;" onclick="document.getElementById('code-modal').style.display='none'">H·ª¶Y</button></div></div>
    <canvas id="starCanvas"></canvas><canvas id="gameCanvas"></canvas>
    <div id="ui-wrapper">
        <div id="top-bar">
            <div class="info-box"><div style="font-weight:900; font-size:20px; color:var(--n-gold)">ü¶ã <span id="ll-val">0</span></div><div id="id-display" class="id-text">ID: 000000</div></div>
            <div class="top-right-btns"><div id="code-btn" onclick="openCodeModal()">Code</div><div id="music-toggle" onclick="toggleMusic()">üîä</div></div>
        </div>
        <div id="menu-center"><h1 id="rank-name">ƒê·ªíNG</h1><button class="btn-start" onclick="startGame()">XU·∫§T TH·∫æ</button></div>
        <div id="bottom-bar"><div class="btn-large" onclick="openShop()">SHOP</div><div class="btn-large" onclick="openHistory()">L·ªäCH S·ª¨</div><div class="btn-large" onclick="claimDailyGift()" style="border-color:var(--n-gold); color:var(--n-gold)">QU√Ä 24H</div></div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAbqk7bAp7FFfB5RR_aHb0T-mBJNnm-Y0s",
      authDomain: "thegioianhsao-4f306.firebaseapp.com",
      databaseURL: "https://thegioianhsao-4f306-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thegioianhsao-4f306",
      storageBucket: "thegioianhsao-4f306.firebasestorage.app",
      messagingSenderId: "257846252596",
      appId: "1:257846252596:web:14a2293cc8132a1807e661",
      measurementId: "G-B60KPDVVLL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let data = JSON.parse(localStorage.getItem('thien_de_final_v12')) || null;

    // L·∫Øng nghe l·ªánh t·ª´ Admin Real-time
    db.ref("ServerSettings").on("value", (snap) => {
        const d = snap.val();
        if(d) {
            localStorage.setItem("SERVER_CODE", d.activeCode);
            localStorage.setItem("SERVER_REWARD", d.rewardAmount);
        }
    });

    // L·∫Øng nghe l·ªánh ban th∆∞·ªüng ri√™ng/to√†n server
    function listenToBonus() {
        if(!data) return;
        db.ref("AdminCommands/Bonus").on("value", (snap) => {
            const cmd = snap.val();
            if(!cmd) return;
            const lastBonus = localStorage.getItem("last_bonus_ts") || 0;
            if(cmd.timestamp > lastBonus) {
                if(cmd.target === "ALL" || cmd.target == data.id) {
                    data.ll += cmd.value;
                    data.history.push({t: new Date().toLocaleTimeString(), m: "Thi√™n Th∆∞·ªüng: +" + cmd.value});
                    save(); updateUI();
                    localStorage.setItem("last_bonus_ts", cmd.timestamp);
                    showMsg("THI√äN TH∆Ø·ªûNG", `ƒê·∫°i ƒê·∫ø ban t·∫∑ng ${cmd.value} LL!`, "var(--n-gold)");
                    db.ref("Players/" + data.id + "/ll").set(data.ll);
                }
            }
        });
    }

    // ƒê·ªìng b·ªô s·ªë d∆∞ l√™n Server th∆∞·ªùng xuy√™n
    function syncToServer() { if(data) db.ref("Players/" + data.id).update({ username: data.username, ll: data.ll, lastSeen: Date.now() }); }

    let bgm = new Audio(); let musicOn = false;
    const songs = { home: 'Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3', shop: 'nhacshop36.mp3', history: 'lichsu5.mp3', play: 'nhactrochoi.mp3', lose: 'thua895.mp3', reward: 'nhanthuong639.mp3' };
    function playBGM(t) { if (!musicOn) return; bgm.pause(); bgm.src = songs[t] || songs.home; bgm.loop = (t==='home'||t==='shop'||t==='play'); bgm.play().catch(()=>{}); }
    function toggleMusic() { musicOn = !musicOn; document.getElementById('music-toggle').classList.toggle('on', musicOn); if(musicOn) playBGM('home'); else { bgm.pause(); bgm.src=""; } }

    function save() { localStorage.setItem('thien_de_final_v12', JSON.stringify(data)); }
    function updateUI() { if(!data) return; document.getElementById('ll-val').innerText = data.ll; document.getElementById('id-display').innerText = "ID: " + data.id; document.getElementById('rank-name').innerText = data.ll >= 5000 ? "V√ÄNG" : (data.ll >= 2000 ? "B·∫†C" : "ƒê·ªíNG"); }
    
    function doLogin() { 
        const u = document.getElementById('reg-user').value; 
        if(u.length < 2) return; 
        if(!data) data = { username: u, id: Math.floor(100000 + Math.random() * 900000), ll: 500, history: [], usedCodes: [], lastDaily: 0 }; 
        save(); document.getElementById('login-screen').style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; 
        updateUI(); syncToServer(); listenToBonus();
    }
    if(data) { document.getElementById('login-screen').style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; updateUI(); syncToServer(); listenToBonus(); }

    function openShop() { playBGM('shop'); showMsg("THI√äN SHOP", `Li√™n h·ªá Admin ƒë·ªÉ n·∫°p Linh L∆∞·ª£ng!`, "var(--n-blue)"); }
    function claimDailyGift() { const now = Date.now(); if (now - (data.lastDaily || 0) >= 86400000) { const r = Math.floor(Math.random() * 401) + 100; data.ll += r; data.lastDaily = now; data.history.push({t: new Date().toLocaleTimeString(), m: "Qu√† 24h: +" + r}); save(); updateUI(); syncToServer(); playBGM('reward'); showMsg("TH√ÄNH C√îNG", `Nh·∫≠n ƒë∆∞·ª£c ${r} LL!`, "var(--n-gold)"); } else showMsg("TH√îNG B√ÅO", "Ch∆∞a ƒë·ªß 24 gi·ªù!", "var(--n-pink)"); }
    function openCodeModal() { document.getElementById('code-modal').style.display = 'flex'; }
    function submitCode() { 
        let c = document.getElementById('input-code-val').value.trim().toUpperCase(); 
        const sC = localStorage.getItem("SERVER_CODE"); 
        const sV = parseInt(localStorage.getItem("SERVER_REWARD")) || 0;
        if(c === sC && !data.usedCodes.includes(c)) { data.ll += sV; data.usedCodes.push(c); data.history.push({t: new Date().toLocaleTimeString(), m: "Code " + c}); save(); updateUI(); syncToServer(); playBGM('reward'); document.getElementById('code-modal').style.display = 'none'; showMsg("K√çCH HO·∫†T", "Nh·∫≠n " + sV + " LL", "var(--n-green)"); }
        else showMsg("TH·∫§T B·∫†I", "M√£ sai ho·∫∑c ƒë√£ d√πng!", "var(--n-red)");
    }
    function openHistory() { playBGM('history'); let list = data.history.slice(-10).reverse().map(x => `<div style="margin-bottom:8px; border-bottom:1px solid #222;">[${x.t}] ${x.m}</div>`).join(''); showMsg("THI√äN K√ù S·ª∞", list || "Tr·ªëng", "var(--n-blue)"); }
    function showMsg(t, b, c) { document.getElementById('msg-title').innerText = t; document.getElementById('msg-title').style.color = c; document.getElementById('msg-body').innerHTML = b; document.getElementById('msg-modal').style.display = 'flex'; }
    function closeMsg() { document.getElementById('msg-modal').style.display = 'none'; if(document.getElementById('gameCanvas').style.display !== 'block') playBGM('home'); }

    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, p = {x:80, y:0, dy:0, s:35}, plats = [], camX = 0, trail = [];
    function startGame() { if(data.ll < 10) return; data.ll -= 10; updateUI(); syncToServer(); save(); playBGM('play'); document.getElementById('ui-wrapper').style.display = 'none'; gCan.style.display = 'block'; playing = true; camX = 0; p.y = 100; p.dy = 0; trail = []; gCan.width = window.innerWidth; gCan.height = window.innerHeight; plats = [{x:0, y:gCan.height-130, w:gCan.width}]; for(let i=0; i<100; i++) plats.push({x: i*450+400, y: gCan.height-(150+Math.random()*150), w: 250}); loop(); }
    function loop() { if(!playing) return; gCtx.clearRect(0,0,gCan.width, gCan.height); camX += 8.2; p.dy += 1.35; p.y += p.dy; gCtx.save(); gCtx.translate(-camX, 0); plats.forEach(pl => { gCtx.fillStyle = '#39ff14'; gCtx.fillRect(pl.x, pl.y, pl.w, 35); if(p.dy >= 0 && p.x+camX+p.s > pl.x && p.x+camX < pl.x+pl.w && p.y+p.s >= pl.y && p.y+p.s <= pl.y+35) { p.y = pl.y - p.s; p.dy = 0; } }); trail.push({x: p.x+camX, y: p.y, h: (Date.now()/5)%360}); if(trail.length > 18) trail.shift(); trail.forEach((t,i) => { gCtx.globalAlpha = i/18*0.6; gCtx.fillStyle=`hsl(${t.h},100%,50%)`; gCtx.fillRect(t.x, t.y, p.s, p.s); }); gCtx.globalAlpha = 1; gCtx.fillStyle = "white"; gCtx.fillRect(p.x+camX, p.y, p.s, p.s); gCtx.restore(); if(p.y > gCan.height) { playing = false; playBGM('lose'); showMsg("K·∫æT TH√öC", "B·∫°i tr·∫≠n!", "var(--n-pink)"); gCan.style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; } else requestAnimationFrame(loop); }
    window.onpointerdown = () => { if(playing && p.dy === 0) p.dy = -27; };
    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let stars = []; function initS() { sCan.width = window.innerWidth; sCan.height = window.innerHeight; for(let i=0; i<1800; i++) stars.push({ x: Math.random()*sCan.width, y: Math.random()*sCan.height, s: Math.random()*2.2, v: Math.random()*0.6, c: ['#00f3ff','#ff00ff','#39ff14','#fff200','#fff'][i%5] }); }
    function drawS() { sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sCan.width, sCan.height); stars.forEach(s => { sCtx.fillStyle = s.c; sCtx.fillRect(s.x, s.y, s.s, s.s); s.y += s.v; if(s.y > sCan.height) s.y = -5; }); requestAnimationFrame(drawS); }
    initS(); drawS();
</script>
</body>
</html>
