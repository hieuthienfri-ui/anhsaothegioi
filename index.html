<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Thi√™n Gi·ªõi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { 
            --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --n-red: #ff3131; 
            --n-purple: #bc13fe; --n-sky: #00ccff; --n-light-pink: #ffb6c1;
            --gold-grad: linear-gradient(45deg, #8a6d3b, #f1d38e, #8a6d3b, #e1b941, #8a6d3b);
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; transition: filter 1.5s ease; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        
        #celestial-msg {
            position: fixed; bottom: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 12px 25px; border-radius: 20px;
            font-size: 15px; z-index: 5000; pointer-events: none; text-align: center;
            border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
            animation: fadeCelestial 4s forwards;
        }
        @keyframes fadeCelestial {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            15% { opacity: 1; transform: translate(-50%, 0); }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        #top-bar { position: absolute; top: 20px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .info-box { background: rgba(0,0,0,0.8); padding: 10px 18px; border-radius: 15px; border: 2px solid var(--n-blue); box-shadow: 0 0 15px var(--n-blue); }
        .id-text { font-size: 15px; font-weight: 900; margin-top: 5px; text-shadow: 0 0 8px currentColor; }
        
        #music-toggle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 3px solid var(--n-red); color: var(--n-red); background: #000; transition: 0.3s; }
        #music-toggle.on { border-color: var(--n-green); color: var(--n-green); box-shadow: 0 0 15px var(--n-green); }
        
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rank-name { font-size: 60px; font-weight: 900; color: var(--n-pink); text-shadow: 0 0 30px var(--n-pink); margin: 0; }
        .btn-start { padding: 18px 55px; border-radius: 50px; background: #000; border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 28px; cursor: pointer; margin-top: 30px; box-shadow: 0 0 20px var(--n-green); text-transform: uppercase; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { width: 88%; max-width: 380px; background: #050505; border: 2px solid var(--n-blue); border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 0 40px rgba(0,243,255,0.15); }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; }
        .modal-msg { font-size: 18px; line-height: 1.5; margin-bottom: 20px; color: #eee; }

        .play-mode-card { background: #0a0a0a; border: 1px solid #333; border-radius: 20px; padding: 18px; margin-bottom: 15px; text-align: left; cursor: pointer; transition: 0.3s; }
        .mode-title { font-size: 19px; font-weight: 900; display: flex; align-items: center; gap: 10px; }
        .mode-desc { font-size: 13px; color: #aaa; margin-top: 5px; padding-left: 30px; }

        .btn-retry { 
            width: 100%; padding: 16px; background: var(--gold-grad); background-size: 200% auto;
            color: #000; border: none; border-radius: 18px; font-weight: 900; font-size: 20px; 
            margin-top: 20px; cursor: pointer; animation: shine 3s linear infinite; box-shadow: 0 0 20px rgba(255,242,0,0.4);
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        #bottom-bar { position: absolute; bottom: 30px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px; box-sizing: border-box; }
        .btn-large { height: 58px; display: flex; align-items: center; justify-content: center; border-radius: 18px; background: rgba(0,0,0,0.7); font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        
        .btn-shop { border: 2.5px solid var(--n-gold); color: var(--n-gold); }
        .btn-garden { border: 2.5px solid var(--n-green); color: var(--n-green); }
        .btn-history { border: 2.5px solid var(--n-purple); color: var(--n-purple); }
        .btn-gift { border: 2.5px solid var(--n-pink); color: var(--n-pink); }

        .shop-item { background: #111; border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { background: var(--n-blue); color: #000; border: none; padding: 8px 16px; border-radius: 10px; font-weight: 900; cursor: pointer; }

        #login-screen { position: fixed; inset: 0; z-index: 4000; background: #000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 85%; max-width: 340px; padding: 30px; border: 3px solid var(--n-blue); border-radius: 30px; text-align: center; }
        .login-box input { width: 100%; padding: 14px; margin: 10px 0; background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; outline: none; box-sizing: border-box; }
        
        .pink-mid { color: #ff4d94; text-shadow: 0 0 15px #ff4d94; }
        .pink-light { color: #ffb3d1; text-shadow: 0 0 15px #ffb3d1; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--n-blue); letter-spacing:3px">THI√äN GI·ªöI</h1>
            <input type="text" id="auth-user" placeholder="T√™n t√†i kho·∫£n...">
            <input type="password" id="auth-pass" placeholder="M·∫≠t m√£...">
            <button class="buy-btn" style="width:100%; height:50px; margin-top:15px; font-size:18px" onclick="handleAuth()">TI·∫æN V√ÄO</button>
        </div>
    </div>

    <div id="gate-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-gold);">
            <div class="modal-title" style="color: var(--n-gold)">XU·∫§T TH·∫æ</div>
            <div class="play-mode-card" style="border-color: var(--n-blue)" onclick="chooseGame('jump')">
                <div class="mode-title" style="color: var(--n-blue)">‚ö° Nh·∫£y B·ª•c</div>
                <div class="mode-desc">V∆∞·ª£t qua c√°c t·∫ßng m√¢y Neon r·ª±c r·ª°.</div>
            </div>
            <div class="play-mode-card" style="border-color: #ff4d94" onclick="chooseGame('flower')">
                <div class="mode-title">
                    <span class="pink-mid">LINH</span> <span class="pink-light">·∫¢NH</span>
                </div>
                <div class="mode-desc">ƒê√†o Hoa C·∫£nh - Phi√™u du trong c√°nh hoa r∆°i.</div>
            </div>
            <button class="btn-large" style="width:100%; border:none; background:#222; color:#fff" onclick="closeCommonModal('gate-modal')">H·ª¶Y</button>
        </div>
    </div>

    <div id="mode-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-green);">
            <div id="mode-modal-title" class="modal-title" style="color: var(--n-green)">CH·∫æ ƒê·ªò</div>
            <div class="play-mode-card" style="border-color: var(--n-sky)" onclick="startGame('practice')">
                <div class="mode-title" style="color: var(--n-sky)">üåø Luy·ªán T√¢m C·∫£nh</div>
                <div class="mode-desc">Tƒ©nh t√¢m tu luy·ªán, kh√¥ng √°p l·ª±c t·ªëc ƒë·ªô.</div>
            </div>
            <div class="play-mode-card" style="border-color: var(--n-red)" onclick="startGame('battle')">
                <div class="mode-title" style="color: var(--n-red)">‚öîÔ∏è ƒê·∫•u Tr∆∞·ªùng</div>
                <div class="mode-desc">Th·ª≠ th√°ch anh h√πng, t·ªëc ƒë·ªô tƒÉng d·∫ßn.</div>
            </div>
            <button class="btn-large" style="width:100%; border:none; background:#222; color:#fff" onclick="closeCommonModal('mode-modal')">QUAY L·∫†I</button>
        </div>
    </div>

    <div id="msg-modal" class="modal">
        <div class="modal-box">
            <div id="msg-title" class="modal-title">TH√îNG B√ÅO</div>
            <div id="msg-body" class="modal-msg"></div>
            <button class="btn-large" style="width:100%; border:none; background:var(--n-blue); color:#000" onclick="closeCommonModal('msg-modal')">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-gold);">
            <div class="modal-title" style="color:var(--n-gold)">THI√äN SHOP NEON</div>
            <div style="max-height: 300px; overflow-y: auto;">
                <div class="shop-item"><span>ID Xanh L√°</span><button class="buy-btn" onclick="buyColor('#39ff14', 1000)">1000 LL</button></div>
                <div class="shop-item"><span>ID V√†ng Neon</span><button class="buy-btn" onclick="buyColor('#fff200', 1000)">1000 LL</button></div>
                <div class="shop-item"><span>ID T√≠m Neon</span><button class="buy-btn" onclick="buyColor('#bc13fe', 1500)">1500 LL</button></div>
            </div>
            <button class="btn-large" style="width:100%; margin-top:15px; background:#222; color:#fff" onclick="closeCommonModal('shop-modal')">ƒê√ìNG</button>
        </div>
    </div>

    <div id="garden-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-green);">
            <div class="modal-title" style="color:var(--n-green)">V∆Ø·ªúN S·ªö & M√É L·ªÜNH</div>
            <div style="margin-bottom: 20px; border-bottom: 1px dashed #333; padding-bottom: 15px;">
                <input type="text" id="gift-code-input" style="width:100%; padding:10px; background:#111; border:1px solid var(--n-gold); color:var(--n-gold); border-radius:10px; text-align:center; box-sizing:border-box" placeholder="NH·∫¨P THI√äN M√É L·ªÜNH...">
                <button class="buy-btn" style="background:var(--n-gold); width:100%; height:35px; margin-top:8px; font-size:14px" onclick="useGiftCode()">K√çCH HO·∫†T M√É</button>
            </div>
            <textarea id="so-tau-text" style="width:100%; height:80px; background:#111; border:1px solid var(--n-green); color:#fff; border-radius:15px; padding:12px; margin-bottom:15px; box-sizing:border-box" placeholder="Nh·∫≠p t√¢m nguy·ªán..."></textarea>
            <button class="buy-btn" style="background:var(--n-green); width:100%; height:45px" onclick="guiSoTau()">G·ª¨I S·ªö (50 LL)</button>
            <button class="btn-large" style="width:100%; margin-top:10px; background:#222; color:#fff" onclick="closeCommonModal('garden-modal')">R·ªúI V∆Ø·ªúN</button>
        </div>
    </div>

    <div id="over-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-red);">
            <div class="modal-title" style="color:var(--n-red); font-size:38px">B·∫†I TR·∫¨N</div>
            <p id="over-score" style="font-size:26px; margin:15px 0; color:#fff; font-weight:900"></p>
            <button class="btn-retry" onclick="startGame(currentMode)">CH∆†I L·∫†I</button>
            <button class="btn-large" style="width:100%; margin-top:10px; border:2px solid var(--n-pink); color:var(--n-pink)" onclick="backToMenu()">V·ªÄ THI√äN ƒê√åNH</button>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-purple);">
            <div class="modal-title" style="color:var(--n-purple)">THI√äN K√ù S·ª∞</div>
            <div id="history-content" style="text-align:left; font-size:14px; color:#ddd; max-height:250px; overflow-y:auto; padding:10px; background:#111; border-radius:15px"></div>
            <button class="btn-large" style="width:100%; margin-top:15px; background:#222; color:#fff" onclick="closeCommonModal('history-modal')">ƒê√ìNG</button>
        </div>
    </div>

    <canvas id="starCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-wrapper">
        <div id="top-bar">
            <div class="info-box">
                <div style="font-weight:900; font-size:24px; color:var(--n-gold)">ü¶ã <span id="ll-val">0</span></div>
                <div id="id-display" class="id-text">ID: ------</div>
            </div>
            <div id="music-toggle" onclick="toggleMusic()">üîä</div>
        </div>
        <div id="menu-center">
            <h1 id="rank-name">ƒê·ªíNG</h1>
            <button class="btn-start" onclick="openModal('gate-modal')">XU·∫§T TH·∫æ</button>
        </div>
        <div id="bottom-bar">
            <div class="btn-large btn-shop" onclick="openAndPlay('shop-modal', 'shop')">SHOP</div>
            <div class="btn-large btn-garden" onclick="openModal('garden-modal')">V∆Ø·ªúN S·ªö</div>
            <div class="btn-large btn-history" onclick="showHistory()">L·ªäCH S·ª¨</div>
            <div id="gift-btn" class="btn-large btn-gift" onclick="claimDailyGift()">QU√Ä 24H</div>
        </div>
    </div>

<script>
    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAbqk7bAp7FFfB5RR_aHb0T-mBJNnm-Y0s",
      authDomain: "thegioianhsao-4f306.firebaseapp.com",
      databaseURL: "https://thegioianhsao-4f306-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thegioianhsao-4f306",
      storageBucket: "thegioianhsao-4f306.firebasestorage.app",
      messagingSenderId: "257846252596",
      appId: "1:257846252596:web:14a2293cc8132a1807e661"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // GLOBAL VARS
    let data = null, musicOn = false, bgm = new Audio();
    let failCount = 0;
    const PRAISE = ["Thi√™n Gi·ªõi ghi nh·∫≠n b∆∞·ªõc ti·∫øn c·ªßa ng∆∞∆°i.", "Ng∆∞∆°i m·∫°nh h∆°n ch√≠nh m√¨nh l√∫c tr∆∞·ªõc.", "T√¢m ng∆∞∆°i v·ªØng, b∆∞·ªõc ch√¢n kh√¥ng lo·∫°n.", "Ng∆∞∆°i ƒë√£ l√†m r·∫•t t·ªët.", "S·ª± ti·∫øn b·ªô n√†y kh√¥ng h·ªÅ t·∫ßm th∆∞·ªùng."];
    const PROVOKE = ["Ng∆∞∆°i d·ª´ng l·∫°i ·ªü ƒë√¢y sao?", "Thi√™n Gi·ªõi tin r·∫±ng ng∆∞∆°i ch∆∞a ƒë·∫øn gi·ªõi h·∫°n.", "Th·ª≠ th√™m l·∫ßn n·ªØa xem sao.", "Gi·ªõi h·∫°n n√†y‚Ä¶ c√≥ th·∫≠t kh√¥ng?"];
    const songs = { home: 'Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3', jump_play: 'nhactrochoi.mp3', flower_play: 'nen7462.mp3', lose: 'thua895.mp3', shop: 'nhacshop36.mp3', history: 'lichsu5.mp3', gift: 'nhanthuong639.mp3' };

    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, currentMode = 'battle', currentGame = 'jump';
    let p, camX, score, trail, plats, flowers, rainPetals, angle = 0, deathAlpha = 0, isDead = false;

    // --- PH·∫¶N K·∫æT N·ªêI V·ªöI ATMINGAME ---
    function listenToAdmin() {
        if(!data) return;
        
        // 1. L·∫Øng nghe Ban Th∆∞·ªüng tr·ª±c ti·∫øp t·ª´ Admin
        db.ref("AdminCommands/Bonus").on("value", (snap) => {
            const cmd = snap.val();
            if(cmd && cmd.timestamp > (data.lastBonusTime || 0)) {
                if(cmd.target === "ALL" || cmd.target == data.uid || cmd.target === data.username) {
                    data.ll += parseInt(cmd.value);
                    data.lastBonusTime = cmd.timestamp;
                    addHistory(`Nh·∫≠n ban th∆∞·ªüng t·ª´ Admin: +${cmd.value} LL`);
                    updateUI(); save();
                    showPopup("THI√äN L·ªòC", `Ng√†i v·ª´a ƒë∆∞·ª£c Admin ban t·∫∑ng ${cmd.value} Linh L∆∞·ª£ng!`, 'var(--n-gold)');
                    playBGM('gift');
                }
            }
        });

        // 2. L·∫Øng nghe M√£ Code Server v·ª´a ph√°t
        db.ref("ServerSettings").on("value", (snap) => {
            const settings = snap.val();
            if(settings && settings.activeCode) {
                // Ch·ªâ th√¥ng b√°o n·∫øu m√£ n√†y ch∆∞a t·ª´ng ƒë∆∞·ª£c d√πng b·ªüi ng∆∞·ªùi ch∆°i n√†y
                if(!data.usedCodes || !data.usedCodes[settings.activeCode]) {
                    showCelestialMessage(`M√£ l·ªánh m·ªõi xu·∫•t hi·ªán: ${settings.activeCode}`);
                }
            }
        });
    }

    // --- C√ÅC H√ÄM C∆† B·∫¢N ---
    function addHistory(msg) {
        if(!data) return;
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth() + 1}`;
        if(!data.history) data.history = [];
        data.history.push({ time: timeStr, text: msg });
        if(data.history.length > 20) data.history.shift();
        save();
    }

    function useGiftCode() {
        const input = document.getElementById('gift-code-input').value.trim().toUpperCase();
        if(!input) return;
        
        // Ki·ªÉm tra m√£ t·ª´ Server (Atmingame ph√°t) ho·∫∑c m√£ c·ªë ƒë·ªãnh
        db.ref("ServerSettings").once("value", (snap) => {
            const settings = snap.val() || {};
            const hardCodes = { "THIENGIOI": 500, "TANTHU": 1000, "LINHANH": 2000 };
            
            let reward = 0;
            if(input === settings.activeCode) reward = settings.rewardAmount;
            else if(hardCodes[input]) reward = hardCodes[input];

            if(!data.usedCodes) data.usedCodes = {};
            if(data.usedCodes[input]) { showPopup("TH·∫§T B·∫†I", "M√£ l·ªánh n√†y ng∆∞∆°i ƒë√£ d√πng r·ªìi!"); return; }
            
            if(reward > 0) {
                data.ll += reward;
                data.usedCodes[input] = true;
                addHistory(`S·ª≠ d·ª•ng m√£ l·ªánh ${input}: +${reward} LL`);
                updateUI(); save(); playBGM('gift');
                showPopup("K√çCH HO·∫†T", `Nh·∫≠n th√†nh c√¥ng ${reward} Linh L∆∞·ª£ng!`, 'var(--n-gold)');
                document.getElementById('gift-code-input').value = "";
            } else { 
                showPopup("SAI M√É", "M√£ l·ªánh kh√¥ng t·ªìn t·∫°i tr√™n Thi√™n ƒê√¨nh."); 
            }
        });
    }

    function showHistory() {
        if(!data) return;
        const content = document.getElementById('history-content');
        content.innerHTML = (data.history || []).map(h => `
            <div style="margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px">
                <span style="color:var(--n-gold); font-size:12px">[${h.time}]</span><br>${h.text}
            </div>
        `).reverse().join('') || "<p style='text-align:center'>Ch∆∞a c√≥ k√Ω s·ª±.</p>";
        openAndPlay('history-modal', 'history');
    }

    function claimDailyGift() {
        if(!data) return;
        const now = Date.now();
        if(now - (data.lastDaily || 0) < 86400000) {
            showPopup("CH∆ØA ƒê·∫æN GI·ªú", "Thi√™n ƒê√¨nh ban qu√† m·ªói 24 gi·ªù.");
            return;
        }
        const reward = Math.floor(Math.random() * 401) + 100;
        data.ll += reward; data.lastDaily = now;
        addHistory(`Nh·∫≠n qu√† 24H: +${reward} Linh L∆∞·ª£ng.`);
        updateUI(); save(); playBGM('gift');
        showPopup("THI√äN L·ªòC", `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${reward} Linh L∆∞·ª£ng!`, 'var(--n-pink)');
    }

    function chooseGame(gameType) {
        currentGame = gameType;
        closeModal('gate-modal');
        document.getElementById('mode-modal-title').innerText = (gameType === 'jump' ? 'NH·∫¢Y B·ª§C' : 'LINH ·∫¢NH');
        openModal('mode-modal');
    }

    function startGame(m) {
        currentMode = m;
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('ui-wrapper').style.display = 'none';
        gCan.style.display = 'block';
        playing = true; isDead = false; deathAlpha = 0; camX = 0; score = 0; trail = []; angle = 0;
        gCan.width = window.innerWidth; gCan.height = window.innerHeight;
        p = { x: (currentGame === 'jump' ? 80 : 100), y: gCan.height / 2, dy: 0, s: 35 };

        if (currentGame === 'jump') {
            plats = [{x:0, y:gCan.height-130, w:gCan.width}];
            for(let i=0; i<500; i++) plats.push({x: i*450+450, y: gCan.height-(150+Math.random()*180), w: 220});
            playBGM('jump_play');
        } else {
            flowers = []; rainPetals = [];
            for(let i=0; i<65; i++) rainPetals.push({x: Math.random()*gCan.width, y: Math.random()*gCan.height, s: Math.random()*6+4, speed: Math.random()*1.4+0.8, angle: Math.random()*Math.PI*2, rotSpeed: Math.random()*0.05-0.025, swing: Math.random()*2+1, flip: Math.random()*Math.PI});
            for(let i=0; i<600; i++) flowers.push({x: i*460+600+(Math.random()*300-150), y: Math.random()*(gCan.height-120)+60, size: Math.random()<0.7?30:(Math.random()<0.9?55:90), opacity: 0.85});
            playBGM('flower_play');
        }
        loop();
    }

    function loop() {
        if(!playing && deathAlpha === 0) return;
        gCtx.clearRect(0,0,gCan.width, gCan.height);

        if (currentGame === 'jump') {
            let speed = currentMode === 'practice' ? 6.5 : 8.5 + (score * 0.05);
            camX += speed; p.dy += 1.4; p.y += p.dy;
            gCtx.save(); gCtx.translate(-camX, 0);
            plats.forEach(pl => {
                gCtx.fillStyle = '#39ff14'; gCtx.fillRect(pl.x, pl.y, pl.w, 35);
                if(p.dy >= 0 && p.x+camX+p.s > pl.x && p.x+camX < pl.x+pl.w && p.y+p.s >= pl.y && p.y+p.s <= pl.y+35) {
                    p.y = pl.y - p.s; p.dy = 0; if(!pl.passed) { pl.passed = true; score++; }
                }
            });
            trail.push({x: p.x+camX, y: p.y, h: (Date.now()/5)%360});
            if(trail.length > 15) trail.shift();
            trail.forEach((t,i) => { gCtx.globalAlpha = i/15*0.5; gCtx.fillStyle = `hsl(${t.h},100%,50%)`; gCtx.fillRect(t.x, t.y, p.s, p.s); });
            gCtx.globalAlpha = 1; gCtx.fillStyle = "#fff"; gCtx.fillRect(p.x+camX, p.y, p.s, p.s);
            gCtx.restore();
            if(p.y > gCan.height) gameOver();
        } else {
            if (isDead) { deathAlpha += 0.0085; if (deathAlpha > 1) deathAlpha = 1; }
            rainPetals.forEach(rp => {
                if(!isDead) {
                    rp.y += rp.speed; rp.x += Math.sin(rp.y / 70) * rp.swing;
                    rp.angle += rp.rotSpeed; rp.flip += 0.04;
                    if(rp.y > gCan.height + 20) { rp.y = -20; rp.x = Math.random() * gCan.width; }
                }
                gCtx.save(); gCtx.translate(rp.x, rp.y); gCtx.rotate(rp.angle); gCtx.scale(1, Math.sin(rp.flip));
                gCtx.fillStyle = `rgba(255, 160, 190, ${0.8 * (1 - deathAlpha)})`;
                gCtx.beginPath(); gCtx.ellipse(0, 0, rp.s, rp.s/1.4, 0, 0, Math.PI * 2); gCtx.fill();
                gCtx.restore();
            });
            if (!isDead) {
                let speed = currentMode === 'practice' ? 4.6 : 4.6 + (score * 0.02);
                p.dy += 0.39; p.y += p.dy; camX += speed; angle += 0.02;
                if(p.y > gCan.height + 100 || p.y < -100) gameOver();
            }
            trail.push({x: p.x, y: p.y});
            if(trail.length > 25) trail.shift();
            trail.forEach((t, i) => {
                let ratio = i / trail.length;
                gCtx.fillStyle = `rgba(180, 100, 255, ${ratio * 0.35 * (1 - deathAlpha)})`; 
                let s = p.s * (0.5 + 0.5 * ratio); gCtx.fillRect(t.x + (p.s-s)/2, t.y + (p.s-s)/2, s, s);
            });
            gCtx.save(); gCtx.translate(-camX, 0);
            flowers.forEach(f => {
                if(f.x > camX - 150 && f.x < camX + gCan.width + 150) {
                    drawDetailedFlower(f);
                    if (!isDead) {
                        let dx = (p.x + camX + p.s/2) - f.x;
                        let dy = (p.y + p.s/2) - f.y;
                        if(Math.sqrt(dx*dx + dy*dy) < f.size * 0.8) { score = Math.floor(camX/100); gameOver(); }
                    }
                }
            });
            gCtx.restore();
            gCtx.save(); gCtx.fillStyle = `rgba(255, 255, 255, ${1 - deathAlpha})`;
            gCtx.shadowBlur = 10; gCtx.shadowColor = "white";
            gCtx.fillRect(p.x, p.y, p.s, p.s); gCtx.restore();
            if (deathAlpha > 0) {
                gCtx.fillStyle = `rgba(0, 0, 0, ${deathAlpha})`; gCtx.fillRect(0, 0, gCan.width, gCan.height);
                gCan.style.filter = `blur(${deathAlpha * 15}px)`;
            } else { gCan.style.filter = `none`; }
        }

        if(!isDead && currentGame !== 'flower') {
            gCtx.fillStyle = "#fff200"; gCtx.font = "900 45px 'Segoe UI'";
            gCtx.fillText("SCORE: " + score, 25, 60);
        }
        if(playing || deathAlpha > 0) requestAnimationFrame(loop);
    }

    function gameOver() {
        if(isDead) return;
        isDead = true; playing = false; failCount++;
        addHistory(`K·∫øt th√∫c m√†n ${currentGame === 'jump' ? 'Nh·∫£y B·ª•c' : 'Linh ·∫¢nh'}. ƒêi·ªÉm: ${score}`);
        setTimeout(() => showFinalOver(), currentGame === 'flower' ? 3000 : 0);
    }

    function showFinalOver() {
        let msg = (score >= (data.bestScore || 0) * 0.9) ? PROVOKE[Math.floor(Math.random()*PROVOKE.length)] : PRAISE[Math.floor(Math.random()*PRAISE.length)];
        showCelestialMessage(msg);
        if(score > (data.bestScore || 0)) { data.bestScore = score; save(); }
        playBGM('lose');
        document.getElementById('over-score').innerText = "C√îNG L·ª∞C: " + score;
        openModal('over-modal');
    }

    function drawDetailedFlower(f) {
        gCtx.save(); gCtx.translate(f.x, f.y); gCtx.rotate(angle * 0.5);
        for (let i = 0; i < 5; i++) {
            gCtx.save(); gCtx.rotate((Math.PI * 2 / 5) * i);
            gCtx.beginPath(); gCtx.moveTo(0, 0);
            gCtx.bezierCurveTo(-f.size/2, f.size/2, -f.size, f.size, 0, f.size * 1.2);
            gCtx.bezierCurveTo(f.size, f.size, f.size/2, f.size/2, 0, 0);
            let g = gCtx.createRadialGradient(0, f.size/2, 0, 0, f.size/2, f.size);
            g.addColorStop(0, `rgba(255, 51, 153, ${f.opacity})`);
            g.addColorStop(1, `rgba(255, 100, 180, 0)`);
            gCtx.fillStyle = g; gCtx.fill(); gCtx.restore();
        }
        gCtx.fillStyle = `rgba(255, 190, 0, ${f.opacity})`;
        gCtx.beginPath(); gCtx.arc(0, 0, f.size/5, 0, Math.PI * 2); gCtx.fill();
        gCtx.restore();
    }

    function playBGM(t) { if(!musicOn) return; bgm.pause(); bgm.src = songs[t] || songs.home; bgm.loop = true; bgm.play().catch(()=>{}); }
    function toggleMusic() { musicOn = !musicOn; document.getElementById('music-toggle').classList.toggle('on', musicOn); if(musicOn) playBGM('home'); else bgm.pause(); }
    function openAndPlay(id, songKey) { openModal(id); playBGM(songKey); }
    function closeCommonModal(id) { closeModal(id); if(musicOn && !playing) playBGM('home'); }
    
    function handleAuth() {
        const user = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if(user.length < 3) return;
        db.ref("Players/" + user).once("value", (snap) => {
            if(snap.val()) {
                if(snap.val().password === pass) { data = snap.val(); loginSuccess(); }
                else showPopup("L·ªñI", "M·∫≠t m√£ kh√¥ng ƒë√∫ng!", 'var(--n-red)');
            } else {
                data = { username: user, password: pass, uid: Math.floor(100000+Math.random()*899999), ll: 500, lastDaily: 0, idColor: '#ff00ff', history: [], bestScore: 0, usedCodes: {} };
                db.ref("Players/" + user).set(data); loginSuccess();
            }
        });
    }

    function loginSuccess() { 
        localStorage.setItem('current_user', data.username); 
        document.getElementById('login-screen').style.display = 'none'; 
        document.getElementById('ui-wrapper').style.display = 'flex'; 
        updateUI(); 
        listenToAdmin(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe l·ªánh t·ª´ Admin
    }

    function updateUI() { 
        if(!data) return; 
        document.getElementById('ll-val').innerText = data.ll; 
        const idDisp = document.getElementById('id-display'); 
        idDisp.innerText = "ID: " + data.uid; 
        idDisp.style.color = data.idColor || 'var(--n-pink)'; 
        document.getElementById('rank-name').innerText = data.ll > 5000 ? "V√ÄNG" : (data.ll > 2000 ? "B·∫†C" : "ƒê·ªíNG"); 
    }

    function save() { if(data) db.ref("Players/" + data.username).update(data); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function backToMenu() { closeModal('over-modal'); gCan.style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; playBGM('home'); }
    function buyColor(color, price) { if(data.ll >= price) { data.ll -= price; data.idColor = color; addHistory(`Mua m√†u ID: ${color}`); updateUI(); save(); showPopup("TH√ÄNH C√îNG", "ƒê√£ ƒë·ªïi h√†o quang ID."); } else showPopup("THI·∫æU LL", "Ng∆∞∆°i c·∫ßn th√™m Linh L∆∞·ª£ng."); }
    function guiSoTau() { const txt = document.getElementById('so-tau-text').value.trim(); if(txt.length > 5 && data.ll >= 50) { data.ll -= 50; addHistory(`G·ª≠i s·ªõ: ${txt}`); document.getElementById('so-tau-text').value = ""; updateUI(); save(); showPopup("GHI NH·∫¨N", "T√¢m nguy·ªán ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n Thi√™n ƒê√¨nh."); } }
    
    window.onpointerdown = (e) => { if(!playing || isDead) return; e.preventDefault(); if(currentGame === 'jump') { if(p.dy === 0) p.dy = -28; } else { p.dy = -7.6; } };

    // STAR BACKGROUND
    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let stars = [];
    function initS() {
        sCan.width = window.innerWidth; sCan.height = window.innerHeight;
        stars = Array.from({length: 800}, () => ({x: Math.random()*sCan.width, y: Math.random()*sCan.height, s: Math.random()*2, v: Math.random()*0.5, c: ['#00f3ff','#ff00ff','#39ff14','#fff200','#fff'][Math.floor(Math.random()*5)]}));
    }
    function drawS() {
        sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sCan.width, sCan.height);
        if (!(playing && currentGame === 'flower')) {
            stars.forEach(s => { sCtx.fillStyle = s.c; sCtx.fillRect(s.x, s.y, s.s, s.s); s.y += s.v; if(s.y > sCan.height) s.y = -5; });
        }
        requestAnimationFrame(drawS);
    }
    initS(); drawS();

    function showPopup(title, body, color = 'var(--n-blue)') { document.getElementById('msg-title').innerText = title; document.getElementById('msg-title').style.color = color; document.getElementById('msg-body').innerText = body; openModal('msg-modal'); }
    function showCelestialMessage(msg) { const old = document.getElementById('celestial-msg'); if(old) old.remove(); const div = document.createElement('div'); div.id = 'celestial-msg'; div.innerText = msg; document.body.appendChild(div); }
    
    const saved = localStorage.getItem('current_user');
    if(saved) db.ref("Players/" + saved).once("value", s => { if(s.val()){ data = s.val(); loginSuccess(); }});
</script>
</body>
</html>
