<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Thi√™n Gi·ªõi Final</title>
    <style>
        :root { --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --bg: #000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; touch-action: none; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }

        /* UI GIAO DI·ªÜN */
        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: flex; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        
        #top-bar { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; justify-content: space-between; }
        .stats-group { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 12px; border: 1.5px solid var(--n-blue); font-weight: bold; }
        
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #rank-name { font-size: 55px; font-weight: 900; color: var(--n-pink); text-shadow: 0 0 20px var(--n-pink); margin: 0; letter-spacing: 2px; }
        .btn-main { padding: 18px 60px; border-radius: 50px; background: #000; border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 24px; cursor: pointer; margin-top: 25px; box-shadow: 0 0 20px var(--n-green); transition: 0.3s; }

        #bottom-bar { position: absolute; bottom: 25px; width: 100%; display: flex; gap: 10px; justify-content: center; padding: 0 15px; box-sizing: border-box; }
        .btn-nav { flex: 1; padding: 14px 0; border-radius: 15px; background: #111; border: 2px solid var(--n-blue); color: var(--n-blue); font-weight: bold; text-align: center; cursor: pointer; font-size: 14px; text-transform: uppercase; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; display: none; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-box { width: 85%; max-width: 320px; background: #000; border: 4px solid var(--n-pink); border-radius: 30px; padding: 25px; text-align: center; box-shadow: 0 0 40px var(--n-pink); }
        .modal-title { font-size: 28px; font-weight: 900; color: var(--n-pink); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .modal-content { font-size: 17px; margin-bottom: 25px; color: #fff; line-height: 1.5; font-weight: bold; }
        .btn-confirm { width: 100%; padding: 14px; background: #000; border: 2px solid var(--n-blue); color: var(--n-blue); border-radius: 15px; font-weight: 900; font-size: 18px; cursor: pointer; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; font-size: 15px; }
        .btn-buy { background: var(--n-green); color: #000; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 900; }
    </style>
</head>
<body>
    <canvas id="starCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-wrapper">
        <div id="top-bar">
            <div style="display:flex; gap:5px;">
                <div class="stats-group">ü¶ã <span id="ll-val">500</span></div>
                <div class="stats-group" style="border-color:var(--n-pink); color:var(--n-pink);">üë§ ƒê·∫°i ƒê·∫ø</div>
            </div>
            <div class="stats-group" style="border-color:var(--n-gold); color:var(--n-gold);">üèÜ <span id="high-val">0</span></div>
        </div>

        <div id="menu-center">
            <h1 id="rank-name">ƒê·ªíNG</h1>
            <p id="exp-info" style="color:var(--n-gold); font-weight:bold; font-size: 18px;">T√çCH L≈®Y: 0 / 50</p>
            <button class="btn-main" onclick="startGame()">XU·∫§T TH·∫æ</button>
        </div>

        <div id="bottom-bar">
            <div class="btn-nav" onclick="openPanel('shop')">SHOP</div>
            <div class="btn-nav" onclick="openPanel('history')">L·ªäCH S·ª¨</div>
            <div class="btn-nav" onclick="receiveGift()" style="background:var(--n-gold); color:#000; border:none; box-shadow: 0 0 10px var(--n-gold);">TH∆Ø·ªûNG</div>
            <div class="btn-nav" id="music-toggle" onclick="toggleSystemAudio()" style="background:var(--n-blue); color:#000; border:none;">NH·∫†C: T·∫ÆT</div>
        </div>
    </div>

    <div id="custom-alert" class="modal">
        <div class="modal-box" id="alert-box">
            <div class="modal-title" id="alert-title">TH√îNG B√ÅO</div>
            <div class="modal-content" id="alert-content"></div>
            <button class="btn-confirm" onclick="closeAlert()">X√ÅC NH·∫¨N</button>
        </div>
    </div>

<script>
    let data = JSON.parse(localStorage.getItem('thien_de_final_v2')) || { 
        ll: 500, highScore: 0, exp: 0, lv: 1, lastGift: 0, history: [] 
    };

    const RANKS = [
        {n:"ƒê·ªíNG", e:50}, {n:"B·∫†C", e:100}, {n:"V√ÄNG", e:200}, {n:"B·∫†CH KIM", e:400},
        {n:"KIM C∆Ø∆†NG", e:800}, {n:"TINH ANH", e:1000}, {n:"CHU·∫®N ƒê·∫æ", e:2000}, {n:"ƒê·∫†I ƒê·∫æ", e:4000}
    ];

    const sounds = {
        home: new Audio('Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3'),
        shop: new Audio('nhacshop36.mp3'),
        history: new Audio('lichsu5.mp3'),
        play: new Audio('nhactrochoi.mp3'),
        lose: new Audio('thua895.mp3'),
        jump: new Audio('nhay577.mp3'),
        land: new Audio('chamdat577.mp3'),
        reward: new Audio('nhanthuong639.mp3')
    };
    let isAudioActive = false;

    function save() { localStorage.setItem('thien_de_final_v2', JSON.stringify(data)); }

    function showAlert(title, content, color = 'var(--n-pink)') {
        const modal = document.getElementById('custom-alert');
        const box = document.getElementById('alert-box');
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-title').style.color = color;
        document.getElementById('alert-content').innerHTML = content;
        box.style.borderColor = color;
        box.style.boxShadow = `0 0 40px ${color}`;
        modal.style.display = 'flex';
    }

    function closeAlert() {
        document.getElementById('custom-alert').style.display = 'none';
        if(!playing) playS('home', true);
    }

    function toggleSystemAudio() {
        isAudioActive = !isAudioActive;
        document.getElementById('music-toggle').innerText = isAudioActive ? "NH·∫†C: B·∫¨T" : "NH·∫†C: T·∫ÆT";
        if(isAudioActive) playS('home', true);
        else Object.values(sounds).forEach(s => { s.pause(); s.currentTime = 0; });
    }

    function playS(key, loop = false) {
        if (!isAudioActive) return;
        Object.keys(sounds).forEach(k => { if(k!=='jump' && k!=='land') { sounds[k].pause(); sounds[k].currentTime = 0; } });
        sounds[key].loop = loop;
        sounds[key].play().catch(() => {});
    }

    function receiveGift() {
        if(isAudioActive) sounds.reward.play();
        let now = Date.now();
        if (now - data.lastGift >= 86400000) {
            data.ll += 100;
            data.lastGift = now;
            save(); updateUI();
            showAlert("TH√ÄNH C√îNG", "ƒê·∫°i ƒê·∫ø ƒë√£ nh·∫≠n 100 Linh L∆∞·ª£ng!", "var(--n-gold)");
        } else {
            let remain = 86400000 - (now - data.lastGift);
            let h = Math.floor(remain / 3600000);
            showAlert("C·∫¢NH B√ÅO", `Linh kh√≠ ƒëang h·ªìi! <br>C·∫ßn ƒë·ª£i ${h} gi·ªù n·ªØa.`, "var(--n-pink)");
        }
    }

    function openPanel(type) {
        playS(type, true);
        if (type === 'shop') {
            let html = `
                <div class="list-item"><span>üåü ƒêan H·ªìi Sinh</span> <b>50 LL</b> <button class="btn-buy" onclick="buy(50)">MUA</button></div>
                <div class="list-item"><span>üöÄ Phi Ki·∫øm</span> <b>100 LL</b> <button class="btn-buy" onclick="buy(100)">MUA</button></div>
                <div class="list-item"><span>üõ° H·ªô Th√¢n Ph√π</span> <b>30 LL</b> <button class="btn-buy" onclick="buy(30)">MUA</button></div>
            `;
            showAlert("THI√äN SHOP", html, "var(--n-gold)");
        } else {
            let hHTML = data.history.length === 0 ? "Ch∆∞a c√≥ k√Ω s·ª≠ tu luy·ªán." : "";
            data.history.slice().reverse().forEach(h => {
                hHTML += `<div class="list-item"><span>${h.time}</span> <b style="color:var(--n-green)">+${h.pts} ƒêi·ªÉm</b></div>`;
            });
            showAlert("L·ªäCH S·ª¨", `<div style="max-height:200px; overflow-y:auto">${hHTML}</div>`, "var(--n-blue)");
        }
    }

    function buy(cost) {
        if(data.ll >= cost) { data.ll -= cost; save(); updateUI(); showAlert("TH√ÄNH C√îNG", "Ph√°p b·∫£o ƒë√£ v√†o kho!", "var(--n-green)"); }
        else showAlert("TH·∫§T B·∫†I", "Linh L∆∞·ª£ng kh√¥ng ƒë·ªß!", "var(--n-pink)");
    }

    // GAME ENGINE & V·∫¨T L√ù
    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, score = 0, p = {x:80, y:0, dy:0, s:35}, plats = [], camX = 0;
    let trail = []; 

    function startGame() {
        if(data.ll < 10) return showAlert("C·∫¢NH B√ÅO", "C·∫ßn 10 Linh L∆∞·ª£ng ƒë·ªÉ kh·ªüi h√†nh!", "var(--n-pink)");
        data.ll -= 10; updateUI(); save();
        playS('play', true);
        document.getElementById('ui-wrapper').style.display = 'none';
        gCan.style.display = 'block';
        playing = true; camX = 0; score = 0; p.y = 100; p.dy = 0; trail = [];
        gCan.width = window.innerWidth; gCan.height = window.innerHeight;
        plats = [{x:0, y:gCan.height-130, w:gCan.width, sc:true}];
        for(let i=0; i<10; i++) spawnPlat();
        gameLoop();
    }

    function spawnPlat() {
        let last = plats[plats.length-1];
        plats.push({x: last.x + last.w + 120 + Math.random()*70, y: gCan.height-130-Math.random()*100, w: 200+Math.random()*100, sc:false});
    }

    function gameLoop() {
        if(!playing) return;
        gCtx.clearRect(0,0,gCan.width, gCan.height);
        camX += (6 + data.lv*0.1); p.dy += 1.25; 
        let nextY = p.y + p.dy;
        let onGround = false;

        gCtx.save(); gCtx.translate(-camX, 0);
        
        plats.forEach(pl => {
            gCtx.fillStyle = '#39ff14'; gCtx.fillRect(pl.x, pl.y, pl.w, 32);
            if(p.dy >= 0 && (p.x+camX+p.s > pl.x) && (p.x+camX < pl.x+pl.w)) {
                if(p.y+p.s <= pl.y && nextY+p.s >= pl.y) {
                    p.y = pl.y - p.s; p.dy = 0; onGround = true;
                    if(isAudioActive) sounds.land.play();
                    if(!pl.sc) { pl.sc = true; score += 5; data.exp += 2; updateUI(); }
                }
            }
        });
        if(!onGround) p.y = nextY;

        // X·ª¨ L√ù V√Ä V·∫º ƒê∆Ø·ªúNG S√ÅNG D√ÄI (TRAIL)
        trail.push({x: p.x + camX, y: p.y});
        if(trail.length > 25) trail.shift(); // ƒê·ªô d√†i v·ª´a ƒë·ªß c·ª±c ƒë·∫πp

        let hueTrail = (Date.now() / 10) % 360;
        trail.forEach((pos, index) => {
            let ratio = index / trail.length; 
            let opacity = ratio * 0.4; 
            let sizeScale = 0.5 + (ratio * 0.5); 
            
            gCtx.globalAlpha = opacity;
            gCtx.shadowBlur = 15;
            gCtx.shadowColor = `hsl(${hueTrail}, 100%, 50%)`;
            gCtx.fillStyle = `hsl(${hueTrail}, 100%, 50%)`;
            
            let s = p.s * sizeScale;
            let offset = (p.s - s) / 2;
            gCtx.fillRect(pos.x + offset, pos.y + offset, s, s);
        });
        gCtx.globalAlpha = 1.0;
        gCtx.shadowBlur = 0;

        // NH√ÇN V·∫¨T CH√çNH
        let hueMain = (Date.now() / 10) % 360;
        gCtx.shadowBlur = 30;
        gCtx.shadowColor = `hsl(${hueMain}, 100%, 50%)`;
        gCtx.fillStyle = "white";
        gCtx.fillRect(p.x+camX, p.y, p.s, p.s); 
        
        gCtx.restore();

        if(plats[0].x+plats[0].w < camX) { plats.shift(); spawnPlat(); }
        if(p.y > gCan.height) {
            playing = false; playS('lose');
            let nowTime = new Date().toLocaleTimeString('vi-VN');
            data.history.push({time: nowTime, pts: score});
            if(data.history.length > 20) data.history.shift();
            if(score > data.highScore) data.highScore = score;
            save();
            showAlert("TH·∫§T B·∫†I", `ƒê·∫°i ƒê·∫ø ƒë√£ r·ªõt ƒë√†i!<br>ƒêi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${score}`, "var(--n-pink)");
            gCan.style.display = 'none'; 
            document.getElementById('ui-wrapper').style.display = 'flex';
            updateUI();
        } else requestAnimationFrame(gameLoop);
    }

    function updateUI() {
        let r = RANKS[0];
        for(let x of RANKS) if(data.exp >= x.e) r = x;
        document.getElementById('ll-val').innerText = data.ll;
        document.getElementById('high-val').innerText = data.highScore;
        document.getElementById('rank-name').innerText = r.n;
        document.getElementById('exp-info').innerText = `T√çCH L≈®Y: ${data.exp} / ${r.e}`;
    }

    window.onpointerdown = () => { if(playing && p.dy === 0) { p.dy = -27; if(isAudioActive) sounds.jump.play(); } };

    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let starLayers = [[], [], []];
    function initStars() {
        sCan.width = window.innerWidth; sCan.height = window.innerHeight;
        const starColors = ['#00f3ff', '#ff00ff', '#39ff14', '#fff200', '#ffffff', '#ff3131'];
        for(let l=0; l<3; l++) {
            for(let i=0; i<600; i++) {
                starLayers[l].push({
                    x: Math.random()*sCan.width, 
                    y: Math.random()*sCan.height, 
                    v: (l+1)*0.3, 
                    s: (l+1)*1,
                    c: starColors[Math.floor(Math.random()*starColors.length)]
                });
            }
        }
    }
    function drawStars() {
        sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sCan.width, sCan.height);
        starLayers.forEach(layer => {
            layer.forEach(s => {
                sCtx.fillStyle = s.c;
                sCtx.fillRect(s.x, s.y, s.s, s.s);
                s.y += s.v; if(s.y > sCan.height) s.y = -5;
            });
        });
        requestAnimationFrame(drawStars);
    }
    initStars(); drawStars(); updateUI();
</script>
</body>
</html>
