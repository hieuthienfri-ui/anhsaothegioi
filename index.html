<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Thi√™n Gi·ªõi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* GI·ªÆ NGUY√äN TO√ÄN B·ªò CSS C·ª¶A NG√ÄI */
        :root { --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --n-red: #ff3131; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        #top-bar { position: absolute; top: 20px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .info-box { background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 15px; border: 2px solid var(--n-blue); box-shadow: 0 0 10px var(--n-blue); }
        .id-text { font-size: 13px; font-weight: bold; margin-top: 5px; transition: 0.3s; }
        .rank-tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #333; margin-left: 5px; color: #fff; }
        .top-right-btns { display: flex; gap: 10px; align-items: center; }
        #code-btn { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; cursor: pointer; border: 2px solid var(--n-gold); color: var(--n-gold); background: #000; box-shadow: 0 0 10px var(--n-gold); }
        #music-toggle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: 3px solid var(--n-red); color: var(--n-red); background: #000; }
        #music-toggle.on { border-color: var(--n-green); color: var(--n-green); box-shadow: 0 0 15px var(--n-green); }
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rank-name { font-size: 60px; font-weight: 900; color: var(--n-pink); text-shadow: 0 0 30px var(--n-pink); margin: 0; }
        .btn-start { padding: 20px 60px; border-radius: 50px; background: #000; border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 26px; cursor: pointer; margin-top: 30px; box-shadow: 0 0 20px var(--n-green); }
        #bottom-bar { position: absolute; bottom: 30px; width: 100%; display: flex; gap: 10px; justify-content: center; padding: 0 10px; box-sizing: border-box; }
        .btn-large { flex: 1; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 15px; background: #000; border: 2px solid var(--n-blue); color: var(--n-blue); font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-box { width: 85%; max-width: 350px; background: #000; border: 3px solid var(--n-pink); border-radius: 30px; padding: 20px; text-align: center; }
        .btn-close { width: 100%; padding: 12px; background: var(--n-blue); color: #000; border: none; border-radius: 12px; font-weight: 900; margin-top: 15px; }
        #login-screen { position: fixed; inset: 0; z-index: 4000; background: #000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 85%; max-width: 340px; padding: 30px; border: 3px solid var(--n-blue); border-radius: 25px; text-align: center; box-shadow: 0 0 20px var(--n-blue); background: #000; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        .shop-container { max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .shop-item { background: #111; border: 1px solid #333; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-buy { background: var(--n-green); color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-weight: 900; }
        .so-tau-input { width: 100%; height: 80px; background: #111; border: 1px solid var(--n-gold); color: #fff; border-radius: 10px; padding: 10px; box-sizing: border-box; margin-top: 10px; outline: none; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--n-blue); margin-bottom:15px">THI√äN GI·ªöI</h1>
            <input type="text" id="auth-user" placeholder="T√™n t√†i kho·∫£n...">
            <input type="password" id="auth-pass" placeholder="M·∫≠t m√£...">
            <button class="btn-large" style="width:100%; margin-top:10px" onclick="handleAuth()">X√ÅC NH·∫¨N</button>
            <p style="font-size: 11px; color: #666; margin-top: 15px;">D√πng t√™n ƒë·ªÉ ƒëƒÉng nh·∫≠p, h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã ID s·ªë c·ªßa Ng√†i.</p>
        </div>
    </div>
    
    <div id="msg-modal" class="modal"><div class="modal-box"><h2 id="msg-title"></h2><div id="msg-body" style="max-height: 250px; overflow-y: auto;"></div><button class="btn-close" onclick="closeMsg()">ƒê√É HI·ªÇU</button></div></div>

    <div id="shop-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-blue);">
            <h2 style="color: var(--n-blue); margin:0">THI√äN SHOP</h2>
            <div class="shop-container">
                <div class="shop-item"><span>M√†u ID: <b style="color:var(--n-pink)">H·ªíNG NEON</b></span><button class="btn-buy" onclick="buy('color', 'var(--n-pink)', 1000)">1K</button></div>
                <div class="shop-item"><span>M√†u ID: <b style="color:var(--n-green)">XANH L·ª§C</b></span><button class="btn-buy" onclick="buy('color', 'var(--n-green)', 1500)">1.5K</button></div>
                <div class="shop-item"><span>Danh Hi·ªáu: <b>H·ªò PH√ÅP</b></span><button class="btn-buy" onclick="buy('rank', 'H·ªò PH√ÅP', 2500)">2.5K</button></div>
                <div class="shop-item"><span>Danh Hi·ªáu: <b>TI√äN PHONG</b></span><button class="btn-buy" onclick="buy('rank', 'TI√äN PHONG', 2000)">2K</button></div>
            </div>
            <button class="btn-close" onclick="closeShop()">R·ªúI SHOP</button>
        </div>
    </div>

    <div id="so-tau-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-gold);">
            <h2 style="color: var(--n-gold); margin:0">S·ªö T√ÇU</h2>
            <textarea id="so-tau-text" class="so-tau-input" placeholder="Vi·∫øt s·ªõ t·∫°i ƒë√¢y..."></textarea>
            <button class="btn-large" style="width:100%; border-color: var(--n-gold); color: var(--n-gold); margin-top: 10px;" onclick="guiSoTau()">G·ª¨I S·ªö</button>
            <button class="btn-close" style="background:#222; color:#fff" onclick="document.getElementById('so-tau-modal').style.display='none'">H·ª¶Y</button>
        </div>
    </div>

    <div id="code-modal" class="modal"><div class="modal-box" style="border-color: var(--n-gold);"><h2 style="color: var(--n-gold); margin-top:0">THI√äN M√É L·ªÜNH</h2><input type="text" id="input-code-val" style="width:90%; padding:15px; background:#111; border:2px dashed var(--n-gold); color:var(--n-gold); text-align:center; margin:15px 0;" placeholder="NH·∫¨P M√É..."><button class="btn-large" style="width:100%; border-color: var(--n-gold); color: var(--n-gold);" onclick="submitCode()">K√çCH HO·∫†T</button><button class="btn-close" style="background: #222; color: #fff;" onclick="document.getElementById('code-modal').style.display='none'">H·ª¶Y</button></div></div>
    
    <canvas id="starCanvas"></canvas><canvas id="gameCanvas"></canvas>
    
    <div id="ui-wrapper">
        <div id="top-bar">
            <div class="info-box">
                <div style="font-weight:900; font-size:20px; color:var(--n-gold)">ü¶ã <span id="ll-val">0</span></div>
                <div id="id-display" class="id-text">ID: ------</div>
            </div>
            <div class="top-right-btns"><div id="code-btn" onclick="openCodeModal()">Code</div><div id="music-toggle" onclick="toggleMusic()">üîä</div></div>
        </div>
        <div id="menu-center"><h1 id="rank-name">ƒê·ªíNG</h1><button class="btn-start" onclick="startGame()">XU·∫§T TH·∫æ</button></div>
        <div id="bottom-bar">
            <div class="btn-large" onclick="openShop()">SHOP</div>
            <div class="btn-large" onclick="document.getElementById('so-tau-modal').style.display='flex'">G·ª¨I S·ªö</div>
            <div class="btn-large" onclick="openHistory()">L·ªäCH S·ª¨</div>
            <div class="btn-large" onclick="claimDailyGift()" style="border-color:var(--n-gold); color:var(--n-gold)">QU√Ä 24H</div>
        </div>
    </div>

<script>
    // PH·∫¶N S·ª¨A ƒê·ªîI CH√çNH ·ªû ƒê√ÇY
    const firebaseConfig = {
      apiKey: "AIzaSyAbqk7bAp7FFfB5RR_aHb0T-mBJNnm-Y0s",
      authDomain: "thegioianhsao-4f306.firebaseapp.com",
      databaseURL: "https://thegioianhsao-4f306-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thegioianhsao-4f306",
      storageBucket: "thegioianhsao-4f306.firebasestorage.app",
      messagingSenderId: "257846252596",
      appId: "1:257846252596:web:14a2293cc8132a1807e661",
      measurementId: "G-B60KPDVVLL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let data = null;

    function handleAuth() {
        const user = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if(user.length < 3 || pass.length < 3) return alert("Qu√° ng·∫Øn!");

        db.ref("Players/" + user).once("value", (snap) => {
            const serverData = snap.val();
            if(serverData) {
                if(serverData.password === pass) {
                    data = serverData;
                    if(!data.uid || data.uid === "undefined") {
                        data.uid = Math.floor(100000 + Math.random() * 899999);
                        save();
                    }
                    loginSuccess();
                } else alert("Sai m·∫≠t m√£!");
            } else {
                const randomID = Math.floor(100000 + Math.random() * 899999);
                data = {
                    username: user, password: pass,
                    uid: randomID, 
                    ll: 500, history: [], usedCodes: [], lastDaily: 0, nameColor: '', rankTag: 'D√ÇN'
                };
                db.ref("Players/" + user).set(data);
                loginSuccess();
            }
        });
    }

    function loginSuccess() {
        localStorage.setItem('current_user', data.username);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('ui-wrapper').style.display = 'flex';
        updateUI();
        listenToBonus();
        listenToServerCode(); // L·∫Øng nghe code t·ª´ Admin
    }

    // T·ª± ƒë·ªông t·∫£i l·∫°i trang khi c√≥ thay ƒë·ªïi t·ª´ Admin
    function listenToBonus() {
        db.ref("AdminCommands/Bonus").on("value", (snap) => {
            const cmd = snap.val();
            if(!cmd) return;
            const lastTs = localStorage.getItem("last_bonus_ts") || 0;
            if(cmd.timestamp > lastTs) {
                // Ki·ªÉm tra n·∫øu target l√† T√™n ho·∫∑c ID s·ªë c·ªßa m√¨nh
                if(cmd.target === "ALL" || cmd.target == data.username || cmd.target == data.uid) {
                    data.ll += parseInt(cmd.value);
                    save(); updateUI();
                    localStorage.setItem("last_bonus_ts", cmd.timestamp);
                    showMsg("THI√äN TH∆Ø·ªûNG", `Ng√†i v·ª´a nh·∫≠n ${cmd.value} Linh L∆∞·ª£ng t·ª´ Atmingame!`, "var(--n-gold)");
                }
            }
        });
    }

    function listenToServerCode() {
        db.ref("ServerSettings").on("value", (snap) => {
            const s = snap.val();
            if(s && s.activeCode) {
                console.log("M√£ l·ªánh hi·ªán t·∫°i: " + s.activeCode);
            }
        });
    }

    function submitCode() { 
        let c = document.getElementById('input-code-val').value.trim().toUpperCase(); 
        db.ref("ServerSettings").once("value", (snap) => {
            const s = snap.val();
            if(s && c === s.activeCode && !data.usedCodes.includes(c)) {
                data.ll += s.rewardAmount;
                data.usedCodes.push(c);
                save(); updateUI();
                playBGM('reward');
                alert(`Th√†nh c√¥ng! Nh·∫≠n ${s.rewardAmount} LL`);
            } else {
                alert("M√£ sai ho·∫∑c ƒë√£ d√πng!");
            }
        });
    }

    function save() { if(data) db.ref("Players/" + data.username).update(data); }
    function updateUI() { 
        if(!data) return; 
        document.getElementById('ll-val').innerText = data.ll; 
        const idDisp = document.getElementById('id-display');
        idDisp.style.color = data.nameColor || 'var(--n-pink)';
        idDisp.innerHTML = `ID: ${data.uid} <span class="rank-tag">${data.rankTag || 'D√ÇN'}</span>`;
        document.getElementById('rank-name').innerText = data.ll >= 5000 ? "V√ÄNG" : (data.ll >= 2000 ? "B·∫†C" : "ƒê·ªíNG"); 
    }

    // --- C√ÅC H√ÄM C√íN L·∫†I GI·ªÆ NGUY√äN ---
    const savedUser = localStorage.getItem('current_user');
    if(savedUser) { db.ref("Players/" + savedUser).once("value", (snap) => { if(snap.val()) { data = snap.val(); if(!data.uid || data.uid === "undefined") { data.uid = Math.floor(100000 + Math.random() * 899999); save(); } loginSuccess(); } }); }
    function buy(type, val, price) { if(data.ll >= price) { data.ll -= price; if(type === 'color') data.nameColor = val; if(type === 'rank') data.rankTag = val; data.history.push({t: new Date().toLocaleTimeString(), m: `Mua ${val}`}); save(); updateUI(); alert("ƒê√£ k√≠ch ho·∫°t!"); } else alert("Thi·∫øu Linh L∆∞·ª£ng!"); }
    function guiSoTau() { const text = document.getElementById('so-tau-text').value.trim(); if(!text) return; db.ref("SoTau").push({ id: data.uid, content: text, time: Date.now() }); document.getElementById('so-tau-text').value = ""; document.getElementById('so-tau-modal').style.display = 'none'; alert("S·ªõ ƒë√£ g·ª≠i!"); }
    let bgm = new Audio(); let musicOn = false;
    const songs = { home: 'Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3', shop: 'nhacshop36.mp3', history: 'lichsu5.mp3', play: 'nhactrochoi.mp3', lose: 'thua895.mp3', reward: 'nhanthuong639.mp3' };
    function playBGM(t) { if (!musicOn) return; bgm.pause(); bgm.src = songs[t] || songs.home; bgm.loop = (t==='home'||t==='shop'||t==='play'); bgm.play().catch(()=>{}); }
    function toggleMusic() { musicOn = !musicOn; document.getElementById('music-toggle').classList.toggle('on', musicOn); if(musicOn) playBGM('home'); else { bgm.pause(); bgm.src=""; } }
    function openShop() { playBGM('shop'); document.getElementById('shop-modal').style.display = 'flex'; }
    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; playBGM('home'); }
    function openHistory() { playBGM('history'); let list = data.history.slice(-10).reverse().map(x => `<div style="margin-bottom:8px; border-bottom:1px solid #222;">[${x.t}] ${x.m}</div>`).join(''); showMsg("THI√äN K√ù S·ª∞", list || "Tr·ªëng", "var(--n-blue)"); }
    function showMsg(t, b, c) { document.getElementById('msg-title').innerText = t; document.getElementById('msg-title').style.color = c; document.getElementById('msg-body').innerHTML = b; document.getElementById('msg-modal').style.display = 'flex'; }
    function closeMsg() { document.getElementById('msg-modal').style.display = 'none'; if(document.getElementById('gameCanvas').style.display !== 'block') playBGM('home'); }
    function claimDailyGift() { const now = Date.now(); if (now - (data.lastDaily || 0) >= 86400000) { const r = Math.floor(Math.random() * 401) + 100; data.ll += r; data.lastDaily = now; save(); updateUI(); playBGM('reward'); showMsg("TH√ÄNH C√îNG", `Nh·∫≠n ${r} LL!`, "var(--n-gold)"); } else showMsg("TH√îNG B√ÅO", "Ch∆∞a ƒë·ªß 24h!", "var(--n-pink)"); }
    function openCodeModal() { document.getElementById('code-modal').style.display = 'flex'; }
    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, p = {x:80, y:0, dy:0, s:35}, plats = [], camX = 0, trail = [];
    function startGame() { if(data.ll < 10) return; data.ll -= 10; updateUI(); save(); playBGM('play'); document.getElementById('ui-wrapper').style.display = 'none'; gCan.style.display = 'block'; playing = true; camX = 0; p.y = 100; p.dy = 0; trail = []; gCan.width = window.innerWidth; gCan.height = window.innerHeight; plats = [{x:0, y:gCan.height-130, w:gCan.width}]; for(let i=0; i<100; i++) plats.push({x: i*450+400, y: gCan.height-(150+Math.random()*150), w: 250}); loop(); }
    function loop() { if(!playing) return; gCtx.clearRect(0,0,gCan.width, gCan.height); camX += 8.2; p.dy += 1.35; p.y += p.dy; gCtx.save(); gCtx.translate(-camX, 0); plats.forEach(pl => { gCtx.fillStyle = '#39ff14'; gCtx.fillRect(pl.x, pl.y, pl.w, 35); if(p.dy >= 0 && p.x+camX+p.s > pl.x && p.x+camX < pl.x+pl.w && p.y+p.s >= pl.y && p.y+p.s <= pl.y+35) { p.y = pl.y - p.s; p.dy = 0; } }); trail.push({x: p.x+camX, y: p.y, h: (Date.now()/5)%360}); if(trail.length > 18) trail.shift(); trail.forEach((t,i) => { gCtx.globalAlpha = i/18*0.6; gCtx.fillStyle=`hsl(${t.h},100%,50%)`; gCtx.fillRect(t.x, t.y, p.s, p.s); }); gCtx.globalAlpha = 1; gCtx.fillStyle = "white"; gCtx.fillRect(p.x+camX, p.y, p.s, p.s); gCtx.restore(); if(p.y > gCan.height) { playing = false; playBGM('lose'); showMsg("K·∫æT TH√öC", "B·∫°i tr·∫≠n!", "var(--n-pink)"); gCan.style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; } else requestAnimationFrame(loop); }
    window.onpointerdown = () => { if(playing && p.dy === 0) p.dy = -27; };
    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let stars = []; function initS() { sCan.width = window.innerWidth; sCan.height = window.innerHeight; for(let i=0; i<1800; i++) stars.push({ x: Math.random()*sCan.width, y: Math.random()*sCan.height, s: Math.random()*2.2, v: Math.random()*0.6, c: ['#00f3ff','#ff00ff','#39ff14','#fff200','#fff'][i%5] }); }
    function drawS() { sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sCan.width, sCan.height); stars.forEach(s => { sCtx.fillStyle = s.c; sCtx.fillRect(s.x, s.y, s.s, s.s); s.y += s.v; if(s.y > sCan.height) s.y = -5; }); requestAnimationFrame(drawS); }
    initS(); drawS();
</script>
</body>
</html>
