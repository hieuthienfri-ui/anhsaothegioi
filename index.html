<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Music Optimized</title>
    <style>
        :root { --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --n-red: #ff0044; --bg: #050505; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Arial', sans-serif; color: white; touch-action: none; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; pointer-events: none; }
        #gameCanvas { z-index: 5; display: none; }
        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: flex; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        #top-info { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 8px; }
        .stat-box { background: rgba(0,0,0,0.8); border: 2px solid var(--n-blue); border-radius: 12px; padding: 8px 15px; font-weight: bold; color: var(--n-blue); box-shadow: 0 0 15px var(--n-blue); min-width: 150px; }
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #rank-name { font-size: 45px; font-weight: 900; margin: 0; text-shadow: 0 0 25px currentColor; }
        .exp-text { color: var(--n-gold); font-weight: bold; margin: 10px 0 25px; font-size: 18px; }
        .btn-main { padding: 15px 60px; border-radius: 40px; background: rgba(0,0,0,0.6); border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 26px; box-shadow: 0 0 30px var(--n-green); cursor: pointer; text-transform: uppercase; }
        #bottom-bar { position: absolute; bottom: 30px; width: 100%; display: flex; gap: 10px; justify-content: center; padding: 0 15px; box-sizing: border-box; }
        .btn-nav { flex: 1; padding: 12px 0; border-radius: 15px; background: #111; border: 2px solid var(--n-blue); color: var(--n-blue); font-weight: bold; text-align: center; cursor: pointer; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { width: 85%; max-width: 320px; background: #000; border: 3px solid var(--n-pink); border-radius: 30px; padding: 25px; box-shadow: 0 0 40px var(--n-pink); text-align: center; }
        .modal-title { font-size: 24px; font-weight: 900; color: var(--n-gold); margin-bottom: 15px; }
        .modal-body { color: #fff; margin-bottom: 20px; text-align: center; font-size: 16px; line-height: 1.6; }
        #game-hud { position: fixed; top: 20px; width: 100%; text-align: center; z-index: 15; display: none; pointer-events: none; }
        #score-val { font-size: 60px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--n-blue); }
    </style>
</head>
<body>
    <canvas id="starCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <div id="ui-wrapper">
        <div id="top-info">
            <div class="stat-box">ü¶ã LINH L∆Ø·ª¢NG: <span id="ll-val">0</span></div>
            <div class="stat-box" style="border-color:var(--n-pink); color:var(--n-pink); font-size:12px;">K·ªà L·ª§C: <span id="high-val">0</span></div>
        </div>
        <div id="menu-center">
            <h1 id="rank-name">ƒê·ªíNG</h1>
            <div class="exp-text">T√çCH L≈®Y: <span id="exp-val">0</span> / <span id="req-val">50</span></div>
            <button class="btn-main" onclick="handleStart()">XU·∫§T TH·∫æ</button>
        </div>
        <div id="bottom-bar">
            <div class="btn-nav" onclick="openShop()">C·ª¨A H√ÄNG</div>
            <div class="btn-nav" onclick="openHistory()">L·ªäCH S·ª¨</div>
            <div class="btn-nav" onclick="openReward()" id="reward-btn">TH∆Ø·ªûNG</div>
        </div>
    </div>
    <div id="game-hud"><div id="score-val">0</div></div>
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="m-title" class="modal-title">TH√îNG B√ÅO</div>
            <div id="m-body" class="modal-body"></div>
            <div id="m-footer"><button id="m-btn" class="btn-main" style="font-size:16px; padding:10px 30px;" onclick="closeM()">ƒê√ìNG</button></div>
        </div>
    </div>

<script>
    // --- KHAI B√ÅO √ÇM THANH THEO T·ªÜP M·ªöI NH·∫§T ---
    const bgMusic = new Audio('Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3'); 
    bgMusic.loop = true; 
    bgMusic.volume = 0.5;

    const sfxJump = new Audio('nhay577.mp3'); 
    const sfxLand = new Audio('chamdat577.mp3');

    // Nh·∫°c n·ªÅn ph√°t khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu ·ªü trang ch·ªß
    window.addEventListener('pointerdown', () => {
        if (!playing && bgMusic.paused) {
            bgMusic.play().catch(e => {});
        }
    }, { once: false });

    // --- D·ªÆ LI·ªÜU ---
    const ranks = [
        {n: "ƒê·ªíNG", req: 50, c: "#cd7f32"}, {n: "B·∫†C", req: 100, c: "#c0c0c0"},
        {n: "V√ÄNG", req: 200, c: "#ffd700"}, {n: "KIM C∆Ø∆†NG", req: 400, c: "#b9f2ff"},
        {n: "TINH ANH", req: 800, c: "#ff00ff"}, {n: "B·∫†CH KIM", req: 8000, c: "#e5e4e2"},
        {n: "CAO TH·ª¶", req: 999999, c: "#ff0000"}
    ];

    let myLL = parseInt(localStorage.getItem('myLL_v2')) || 0;
    let highScore = parseInt(localStorage.getItem('highScore_v2')) || 0;
    let myExp = parseInt(localStorage.getItem('myExp_v2')) || 0;
    let rankIdx = parseInt(localStorage.getItem('rankIdx_v2')) || 0;
    let historyData = JSON.parse(localStorage.getItem('history_v2')) || [];

    function saveAll() {
        localStorage.setItem('myLL_v2', myLL);
        localStorage.setItem('highScore_v2', highScore);
        localStorage.setItem('myExp_v2', myExp);
        localStorage.setItem('rankIdx_v2', rankIdx);
        localStorage.setItem('history_v2', JSON.stringify(historyData));
    }

    function updateUI() {
        document.getElementById('ll-val').innerText = myLL;
        document.getElementById('high-val').innerText = highScore;
        document.getElementById('rank-name').innerText = ranks[rankIdx].n;
        document.getElementById('rank-name').style.color = ranks[rankIdx].c;
        document.getElementById('exp-val').innerText = myExp;
        document.getElementById('req-val').innerText = ranks[rankIdx].req;
    }

    // --- HI·ªÜU ·ª®NG SAO ---
    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let sw, sh, stars = [];
    function initStars() {
        sw = sCan.width = window.innerWidth; sh = sCan.height = window.innerHeight;
        stars = [];
        for(let i=0; i<800; i++) stars.push({x:Math.random()*sw, y:Math.random()*sh, s:Math.random()*2, v:Math.random()*0.5+0.1, c:`hsl(${Math.random()*360}, 100%, 80%)`});
    }
    function drawStars() {
        sCtx.fillStyle = '#050505'; sCtx.fillRect(0,0,sw,sh);
        stars.forEach(s => { sCtx.fillStyle = s.c; sCtx.fillRect(s.x, s.y, s.s, s.s); s.y += s.v; if(s.y > sh) s.y = -5; });
        requestAnimationFrame(drawStars);
    }

    // --- QU·∫¢N L√ù TR√í CH∆†I ---
    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, score = 0, speed = 6, camX = 0, currentLv = 0;
    let p = {x:100, y:0, dy:0, s:45, trail: []};
    let plats = [];
    const levelMilestones = [70, 140, 260, 400, 700];

    // --- T·∫ÆT NH·∫†C KHI CH∆†I ---
    function handleStart() {
        bgMusic.pause(); 
        bgMusic.currentTime = 0;
        startGame();
    }

    function startGame() {
        playing = true; score = 0; camX = 0; p.y = sh/2; p.dy = 0; currentLv = 0; p.trail = [];
        plats = [{x:0, y:sh-150, w:sw, type:'safe', sc:true}];
        for(let i=0; i<15; i++) createPlat();
        gCan.width = sw; gCan.height = sh;
        gCan.style.display = 'block';
        document.getElementById('ui-wrapper').style.display = 'none';
        document.getElementById('game-hud').style.display = 'block';
        gameLoop();
    }

    function backToHome() {
        playing = false;
        bgMusic.play().catch(e => {}); // Ph√°t l·∫°i nh·∫°c khi v·ªÅ menu
        gCan.style.display = 'none';
        document.getElementById('game-hud').style.display = 'none';
        document.getElementById('ui-wrapper').style.display = 'flex';
        updateUI();
    }

    function createPlat() {
        let last = plats[plats.length-1];
        let type = 'normal';
        if(score >= 260) type = Math.random()>0.8?'move':'normal';
        else if(score >= 70) type = Math.random()>0.7?'ice':'normal';
        plats.push({x: last.x + last.w + 120 + Math.random()*80, y: sh-150-Math.random()*60, w: 180+Math.random()*100, type, dir:1, sc:false});
    }

    function gameLoop() {
        if(!playing) return;
        gCtx.clearRect(0,0,sw,sh);
        
        if(score >= levelMilestones[currentLv]) {
            playing = false;
            currentLv++;
            popM("THƒÇNG C·∫§P", `ƒê·∫°t C·∫•p ${currentLv}.<br>Ti·∫øp t·ª•c ƒë·ªôt ph√°?`, true, () => { playing = true; gameLoop(); });
            return;
        }
        speed = 6 + (currentLv * 3);
        camX += speed; p.dy += 1.5; p.y += p.dy;
        document.getElementById('score-val').innerText = score;

        gCtx.save(); gCtx.translate(-camX, 0);
        plats.forEach(pl => {
            if(pl.type === 'move') { pl.y += pl.dir * 3; if(pl.y > sh-100 || pl.y < sh-300) pl.dir *= -1; }
            gCtx.fillStyle = pl.type==='ice'?'#00f3ff':(pl.type==='move'?'#ff00ff':'#39ff14');
            gCtx.fillRect(pl.x, pl.y, pl.w, 40);
            
            // X·ª≠ l√Ω va ch·∫°m v√† √¢m thanh ti·∫øp ƒë·∫•t
            if(p.dy > 0 && p.x+camX+p.s > pl.x && p.x+camX < pl.x+pl.w && p.y+p.s > pl.y && p.y+p.s < pl.y+40) {
                if(p.dy > 2.5) {
                    sfxLand.currentTime = 0;
                    sfxLand.play().catch(e => {}); // S·ª≠ d·ª•ng chamdat577.mp3
                }
                p.y = pl.y - p.s; p.dy = 0;
                if(!pl.sc) { 
                    pl.sc = true; 
                    if(pl.type !== 'safe') {
                        score += 5; myExp += 1;
                        if(score % 10 === 0) { myLL += 1; saveAll(); }
                        if(myExp >= ranks[rankIdx].req) { myExp = 0; rankIdx++; saveAll(); }
                    }
                }
            }
        });
        
        p.trail.push({x: p.x + camX, y: p.y}); if(p.trail.length > 12) p.trail.shift();
        p.trail.forEach((t, i) => { gCtx.fillStyle = `hsla(${Date.now()/5 + i*20},100%,50%,${i/12})`; gCtx.fillRect(t.x, t.y, p.s, p.s); });
        gCtx.fillStyle = "white"; gCtx.fillRect(p.x + camX, p.y, p.s, p.s);
        gCtx.restore();

        if(plats[0].x + plats[0].w < camX) { plats.shift(); createPlat(); }
        if(p.y > sh + 100) {
            playing = false;
            if(score > highScore) highScore = score;
            historyData.unshift({s: score, r: ranks[rankIdx].n, t: new Date().toLocaleTimeString()});
            if(historyData.length > 5) historyData.pop();
            saveAll();
            popM("K·∫æT TH√öC", `Ghi ƒë∆∞·ª£c ${score} ƒëi·ªÉm.<br>K·ªâ l·ª•c: ${highScore}`, false, () => backToHome());
        } else requestAnimationFrame(gameLoop);
    }

    function popM(t, b, confirmMode = false, onBtn = null) {
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-body').innerHTML = b;
        document.getElementById('m-btn').innerText = confirmMode ? "TI·∫æP T·ª§C" : "ƒê√ìNG";
        document.getElementById('m-btn').onclick = () => { closeM(); if(onBtn) onBtn(); };
        document.getElementById('custom-modal').style.display = 'flex';
    }
    function closeM() { document.getElementById('custom-modal').style.display = 'none'; }

    function openReward() {
        myLL += 50; saveAll(); updateUI();
        popM("TH∆Ø·ªûNG", "Nh·∫≠n th√†nh c√¥ng 50 Linh L∆∞·ª£ng!");
        document.getElementById('reward-btn').style.opacity = "0.5";
        document.getElementById('reward-btn').onclick = () => popM("TH√îNG B√ÅO", "B·∫°n ƒë√£ nh·∫≠n qu√† h√¥m nay r·ªìi!");
    }

    function openHistory() {
        let h = "<b>K·ªà L·ª§C: " + highScore + "</b><br><br>";
        historyData.forEach(i => h += `‚Ä¢ ${i.t}: ${i.s}ƒë (${i.r})<br>`);
        popM("L·ªäCH S·ª¨", h || "Ch∆∞a c√≥ d·ªØ li·ªáu.");
    }

    function openShop() {
        popM("C·ª¨A H√ÄNG", `
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span>H·ªìi Sinh</span>
                <button class="btn-nav" style="flex:none; padding:5px 10px;" onclick="buy(100)">100 LL</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>C√°nh</span>
                <button class="btn-nav" style="flex:none; padding:5px 10px;" onclick="buy(200)">200 LL</button>
            </div>
        `);
    }

    function buy(price) {
        if(myLL >= price) { myLL -= price; saveAll(); updateUI(); popM("TH√ÄNH C√îNG", "ƒê√£ mua v·∫≠t ph·∫©m!"); }
        else popM("TH·∫§T B·∫†I", "Kh√¥ng ƒë·ªß Linh L∆∞·ª£ng!");
    }

    // --- S·ª∞ KI·ªÜN NH·∫¢Y ---
    window.onpointerdown = (e) => { 
        if(playing && p.dy === 0 && e.target.tagName !== 'BUTTON') {
            p.dy = -26; 
            sfxJump.currentTime = 0; 
            sfxJump.play().catch(e => {}); // S·ª≠ d·ª•ng nhay577.mp3
        } 
    };

    initStars(); drawStars(); updateUI();
    window.onresize = initStars;
</script>
</body>
</html>
