<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°i ƒê·∫ø Ch√≠ T√¥n - Thi√™n Gi·ªõi & CƒÉn Ph√≤ng 13</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* CSS CODE 1 */
        :root { 
            --n-blue: #00f3ff; --n-green: #39ff14; --n-pink: #ff00ff; --n-gold: #fff200; --n-red: #ff3131; 
            --n-purple: #bc13fe; --n-sky: #00ccff; --n-light-pink: #ffb6c1;
            --n-pink-mid: #ff4d94; /* M√†u h·ªìng trung */
            --n-purple-mid: #a020f0; /* M√†u t√≠m trung */
            --gold-grad: linear-gradient(45deg, #8a6d3b, #f1d38e, #8a6d3b, #e1b941, #8a6d3b);
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; transition: filter 1.5s ease; }
        canvas { position: fixed; inset: 0; display: block; }
        #starCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        
        #celestial-msg {
            position: fixed; bottom: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 12px 25px; border-radius: 20px;
            font-size: 15px; z-index: 5000; pointer-events: none; text-align: center;
            border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
            animation: fadeCelestial 4s forwards;
        }
        @keyframes fadeCelestial {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            15% { opacity: 1; transform: translate(-50%, 0); }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        #ui-wrapper { position: absolute; inset: 0; z-index: 10; display: none; flex-direction: column; pointer-events: none; }
        #ui-wrapper * { pointer-events: auto; }
        #top-bar { position: absolute; top: 20px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .info-box { background: rgba(0,0,0,0.8); padding: 10px 18px; border-radius: 15px; border: 2px solid var(--n-blue); box-shadow: 0 0 15px var(--n-blue); }
        .id-text { font-size: 15px; font-weight: 900; margin-top: 5px; text-shadow: 0 0 8px currentColor; }
        
        /* C·∫≠p nh·∫≠t Music Toggle m·∫∑c ƒë·ªãnh ƒë·ªè neon */
        #music-toggle { 
            width: 50px; height: 50px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; cursor: pointer; 
            border: 3px solid var(--n-red); color: var(--n-red); 
            background: #000; transition: 0.3s; 
            box-shadow: 0 0 10px var(--n-red);
        }
        
        #menu-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #rank-name { font-size: 60px; font-weight: 900; color: var(--n-pink); text-shadow: 0 0 30px var(--n-pink); margin: 0; }
        .btn-start { padding: 18px 55px; border-radius: 50px; background: #000; border: 4px solid var(--n-green); color: var(--n-green); font-weight: 900; font-size: 28px; cursor: pointer; margin-top: 30px; box-shadow: 0 0 20px var(--n-green); text-transform: uppercase; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { width: 88%; max-width: 380px; background: #050505; border: 2px solid var(--n-blue); border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 0 40px rgba(0,243,255,0.15); }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; }
        .modal-msg { font-size: 18px; line-height: 1.5; margin-bottom: 20px; color: #eee; }

        .play-mode-card { background: #0a0a0a; border: 1px solid #333; border-radius: 20px; padding: 18px; margin-bottom: 15px; text-align: left; cursor: pointer; transition: 0.3s; }
        .mode-title { font-size: 19px; font-weight: 900; display: flex; align-items: center; gap: 10px; }
        .mode-desc { font-size: 13px; color: #aaa; margin-top: 5px; padding-left: 30px; }

        /* Style cho danh s√°ch nh·∫°c */
        .music-item { padding: 15px; margin: 10px 0; border: 2px solid #333; color: #888; border-radius: 15px; font-weight: 900; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .music-item.active-yellow { border-color: var(--n-gold); color: var(--n-gold); box-shadow: 0 0 10px var(--n-gold); }
        .music-item.active-purple { border-color: var(--n-purple-mid); color: var(--n-purple-mid); box-shadow: 0 0 10px var(--n-purple-mid); }
        .music-item.active-pink { border-color: var(--n-pink-mid); color: var(--n-pink-mid); box-shadow: 0 0 10px var(--n-pink-mid); }

        .btn-retry { 
            width: 100%; padding: 16px; background: var(--gold-grad); background-size: 200% auto;
            color: #000; border: none; border-radius: 18px; font-weight: 900; font-size: 20px; 
            margin-top: 20px; cursor: pointer; animation: shine 3s linear infinite; box-shadow: 0 0 20px rgba(255,242,0,0.4);
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        #bottom-bar { position: absolute; bottom: 30px; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px; box-sizing: border-box; }
        .btn-large { height: 58px; display: flex; align-items: center; justify-content: center; border-radius: 18px; background: rgba(0,0,0,0.7); font-weight: 900; font-size: 14px; cursor: pointer; text-transform: uppercase; }
        
        .btn-shop { border: 2.5px solid var(--n-gold); color: var(--n-gold); }
        .btn-garden { border: 2.5px solid var(--n-green); color: var(--n-green); }
        .btn-history { border: 2.5px solid var(--n-purple); color: var(--n-purple); }
        .btn-gift { border: 2.5px solid var(--n-pink); color: var(--n-pink); }

        /* CSS CODE 2 */
        #room13-container { display: none; position: fixed; inset: 0; z-index: 200; background: #000; touch-action: none; }
        #viewport { perspective: 1500px; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #pan-container { position: relative; width: 360px; height: 500px; transform-style: preserve-3d; transition: transform 0.1s ease-out; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-active { animation: shake 0.5s; border-color: red !important; }
        #room-wrapper { position: relative; width: 340px; height: 480px; background: #150021; border: 12px solid #2a004a; transition: all 0.5s; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .wall-front { position: absolute; width: 100%; height: 65px; top: -79px; left: -12px; background: #000044; border: 12px solid #000066; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; z-index: 10; }
        .hp-bar { width: 80px; height: 6px; background: #444; border: 1px solid #000; margin-bottom: 5px; }
        .hp-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.3s; }
        #door-top { width: 80px; height: 8px; background: #0000FF; border: 2px solid #1E90FF; box-shadow: 0 0 10px #00008B; }
        #grid { display: grid; grid-template-columns: repeat(7, 40px); gap: 5px; padding: 10px; justify-content: center; margin-top: 15px; position: relative; z-index: 2; }
        .tile { width: 40px; height: 40px; background: rgba(34, 34, 34, 0.6); border: 1px solid #444; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; color: #444; }
        .aura { position: absolute; width: 100%; height: 100%; border-radius: 50%; filter: blur(8px); animation: pulse 1.5s infinite alternate; z-index: 0; }
        @keyframes pulse { from { opacity: 0.4; transform: scale(0.8); } to { opacity: 0.9; transform: scale(1.2); } }
        .aura-lua { background: radial-gradient(circle, gold, red, orange); }
        .aura-bang { background: radial-gradient(circle, #e0ffff, #00ffff, #fff); }
        .aura-tinhlinh { background: radial-gradient(circle, #00ff00, #0000ff); }
        .aura-hoden { background: radial-gradient(circle, #8b0000, #000); box-shadow: 0 0 15px #ff0000; }
        .aura-cau { background: radial-gradient(circle, #ff00ff, #4b0082); animation: spinAura 3s linear infinite; }
        @keyframes spinAura { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .item-img { width: 42px !important; height: 42px !important; object-fit: contain; z-index: 999; transform: translateY(-10px); animation: standUp 2s infinite alternate ease-in-out; pointer-events: none; }
        @keyframes standUp { from { transform: translateY(-10px); } to { transform: translateY(-18px); } }
        .spirit-img { width: 35px !important; height: 35px !important; object-fit: contain; z-index: 998; pointer-events: none; filter: drop-shadow(0 0 5px #ff00ff); }
        .monster { position: absolute; width: 90px; height: 110px; z-index: 1000; top: -160px; left: 125px; transform-style: preserve-3d; pointer-events: none; transition: top 1.5s ease-in-out, opacity 1s, filter 0.3s; }
        .monster img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px red); transition: filter 0.3s; }
        .m-hp-bar { position: absolute; top: -15px; left: 0; width: 100%; height: 5px; background: #222; border: 1px solid #000; }
        .m-hp-fill { width: 100%; height: 100%; background: #00ff00; transition: width 0.2s; }
        .m-lvl-tag { position: absolute; top: -30px; width: 100%; text-align: center; color: #ff0000; font-weight: bold; font-size: 11px; text-shadow: 1px 1px #000; }
        .rage-mode img { filter: drop-shadow(0 0 25px #fff) brightness(1.5) !important; }
        .evil-mode { filter: sepia(100%) hue-rotate(250deg) saturate(300%) !important; }
        .skill-notify { position: absolute; top: -60px; width: 150px; left: -30px; text-align: center; color: yellow; font-weight: bold; font-size: 14px; text-shadow: 0 0 5px #000; animation: floatUp 1s forwards; z-index: 2000; pointer-events: none; }
        @keyframes floatUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-30px); opacity: 0; } }
        .bullet { position: absolute; z-index: 2000; pointer-events: none; transition: all 0.4s linear; }
        .bullet-lua { width: 35px; height: 35px; background: radial-gradient(circle, #fff, #ff4500, transparent); border-radius: 50%; box-shadow: 0 0 15px #ff4500; }
        .bullet-bang { width: 6px; height: 30px; background: #00f2ff; box-shadow: 0 0 10px #00f2ff; border-radius: 3px; }
        .bullet-tinhlinh { width: 20px; height: 20px; background: #32cd32; border-radius: 50%; box-shadow: 0 0 10px #32cd32; border: 1px solid #fff; }
        .bullet-hoden { width: 15px; height: 50px; background: #000; border: 1px solid #9d00ff; box-shadow: 0 0 15px #9d00ff; border-radius: 50%; }
        #center-countdown { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: bold; color: #fff; z-index: 5000; pointer-events: none; }
        #coin-ui { position: fixed; top: 20px; left: 20px; font-size: 14px; color: #d4af37; z-index: 3000; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; pointer-events: none; }
        
        #shop-ui, #upgrade-ui, #door-upgrade-ui, #spirit-ui { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 240px; background: rgba(10,10,10,0.95); border: 1px solid #d4af37; 
            display: none; flex-direction: column; align-items: center; z-index: 4000; 
            padding: 15px; border-radius: 8px; box-shadow: 0 0 30px #000;
        }
        .shop-item { width: 95%; padding: 8px; border-bottom: 1px solid #333; margin: 3px; background: #1a1a1a; display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #fff; }
        .shop-item img { width: 25px; height: 25px; margin-right: 10px; }
        .close-btn { margin-top:10px; padding: 5px 15px; background: #d4af37; color: #000; border: none; font-weight: bold; cursor: pointer; font-size: 12px; }
        .lvl-tag { position: absolute; bottom: 0; right: 0; font-size: 9px; background: #000; color: #fff; padding: 1px 2px; }
        .spirit-row { display: flex; justify-content: space-between; width: 100%; font-size: 12px; margin: 3px 0; color: #fff; }
        .exit-room-btn { position: fixed; top: 20px; right: 20px; z-index: 4000; background: #ff3131; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        #login-screen { position: fixed; inset: 0; z-index: 4000; background: #000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 85%; max-width: 340px; padding: 30px; border: 3px solid var(--n-blue); border-radius: 30px; text-align: center; }
        .login-box input { width: 100%; padding: 14px; margin: 10px 0; background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; outline: none; box-sizing: border-box; }
        
        .pink-mid { color: #ff4d94; text-shadow: 0 0 15px #ff4d94; }
        .pink-light { color: #ffb3d1; text-shadow: 0 0 15px #ffb3d1; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--n-blue); letter-spacing:3px">THI√äN GI·ªöI</h1>
            <input type="text" id="auth-user" placeholder="T√™n t√†i kho·∫£n...">
            <input type="password" id="auth-pass" placeholder="M·∫≠t m√£...">
            <button class="buy-btn" style="width:100%; height:50px; margin-top:15px; font-size:18px; background: var(--n-blue); border:none; border-radius:10px; font-weight:900" onclick="handleAuth()">TI·∫æN V√ÄO</button>
        </div>
    </div>

    <div id="music-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-blue);">
            <div class="modal-title" style="color: var(--n-blue)">CH·ªåN √ÇM THANH</div>
            <div id="m-song-1" class="music-item" onclick="selectMusic('Gi·ªØa tr·ªùi ƒë√™m ƒë·∫ßy sao.mp3', 'm-song-1', 'gold')">Nh·∫°c √°nh sao</div>
            <div id="m-song-2" class="music-item" onclick="selectMusic('C√°nh hoa r∆°i.mp3', 'm-song-2', 'purple')">Nh·∫°c c√°nh hoa</div>
            <div id="m-song-3" class="music-item" onclick="selectMusic('H√¥m nay tim em.mp3', 'm-song-3', 'pink')">T√¨nh y√™u nh·∫π</div>
            <button class="btn-large" style="width:100%; border:none; background:#222; color:#fff; margin-top:10px" onclick="closeCommonModal('music-modal')">ƒê√ìNG</button>
        </div>
    </div>

    <div id="gate-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-gold);">
            <div class="modal-title" style="color: var(--n-gold)">XU·∫§T TH·∫æ</div>
            <div class="play-mode-card" style="border-color: var(--n-blue)" onclick="chooseGame('jump')">
                <div class="mode-title" style="color: var(--n-blue)">‚ö° Nh·∫£y B·ª•c</div>
                <div class="mode-desc">V∆∞·ª£t qua c√°c t·∫ßng m√¢y Neon r·ª±c r·ª°.</div>
            </div>
            <div class="play-mode-card" style="border-color: #ff4d94" onclick="chooseGame('flower')">
                <div class="mode-title">
                    <span class="pink-mid">LINH</span> <span class="pink-light">·∫¢NH</span>
                </div>
                <div class="mode-desc">ƒê√†o Hoa C·∫£nh - Phi√™u du trong c√°nh hoa r∆°i.</div>
            </div>
            <div class="play-mode-card" style="border-color: var(--n-purple)" onclick="chooseGame('room13')">
                <div class="mode-title" style="color: var(--n-purple)">üè∞ CƒÉn Ph√≤ng Th·ª© 13</div>
                <div class="mode-desc">Th·ªß th√†nh, luy·ªán t·∫≠p v√† ƒë·∫•u tr∆∞·ªùng ma qu√°i.</div>
            </div>
            <button class="btn-large" style="width:100%; border:none; background:#222; color:#fff" onclick="closeCommonModal('gate-modal')">H·ª¶Y</button>
        </div>
    </div>

    <div id="room13-container">
        <button class="exit-room-btn" onclick="backToMenuFromRoom()">THO√ÅT</button>
        <div id="coin-ui">Xu: <span id="coin-num">0</span> | Ma Lv: <span id="m-lvl-ui">1</span> | C·ª≠a Lv: <span id="door-lvl-ui">1</span></div>
        <div id="center-countdown">30</div>
        <div id="viewport">
            <div id="pan-container">
                <div id="room-wrapper">
                    <div class="wall-front" onclick="Game.openDoorUpgrade()">
                        <div class="hp-bar"><div id="door-hp" class="hp-fill"></div></div>
                        <div id="door-top"></div>
                    </div>
                    <div id="grid"></div>
                </div>
            </div>
        </div>
        <div id="shop-ui">
            <div class="shop-item" onclick="Game.buy('lua')"><img src="Lua68.png"> L·ª≠a (16)</div>
            <div class="shop-item" onclick="Game.buy('bang')"><img src="Ban44.png"> BƒÉng (16)</div>
            <div class="shop-item" onclick="Game.buy('tinhlinh')"><img src="Cay.png"> Tinh Linh (26)</div>
            <div class="shop-item" onclick="Game.buy('hoden')"><img src="Hoden.png"> H·ªë ƒêen (26)</div>
            <button class="close-btn" onclick="Game.closeShop()">ƒê√ìNG</button>
        </div>
        <div id="upgrade-ui">
            <div style="font-size:14px; margin-bottom:5px;" id="up-name">N√ÇNG C·∫§P G·∫¨Y</div>
            <div style="font-size:12px; color:#fff">Lv: <span id="up-curr-lvl"></span> ‚ûî <span id="up-next-lvl"></span></div>
            <div style="font-size:12px; color:#d4af37;">Gi√°: <span id="up-price"></span> xu</div>
            <button class="close-btn" style="background:#28a745; color:#fff;" onclick="Game.confirmUpgrade()">N√ÇNG</button>
            <button class="close-btn" onclick="document.getElementById('upgrade-ui').style.display='none'">X</button>
        </div>
        <div id="door-upgrade-ui">
            <div style="font-size:14px; margin-bottom:5px; color:#fff">N√ÇNG C·∫§P C·ª¨A</div>
            <div style="font-size:12px; color:#fff">C·∫•p hi·ªán t·∫°i: <span id="door-curr-lvl">1</span></div>
            <div style="font-size:12px; color:#d4af37;">Gi√°: <span id="door-up-price">16</span> xu</div>
            <button class="close-btn" style="background:#28a745; color:#fff;" onclick="Game.confirmDoorUpgrade()">N√ÇNG C·ª¨A</button>
            <button class="close-btn" onclick="document.getElementById('door-upgrade-ui').style.display='none'">X</button>
        </div>
        <div id="spirit-ui">
            <h3 style="color:#d4af37; margin: 0 0 15px 0; font-size:16px;">LINH C·∫¶U</h3>
            <div class="spirit-row"><span>C·∫•p kh·∫ø ∆∞·ªõc:</span><span class="spirit-val" id="sp-lvl">1</span></div>
            <div class="spirit-row"><span>S·ªë ti·ªÅn/s:</span><span class="spirit-val" id="sp-inc">1</span></div>
            <div style="width:100%; border-top: 1px solid #555; margin: 5px 0;"></div>
            <div class="spirit-row"><span>Ti·ªÅn c·∫ßn l√™n c·∫•p:</span><span class="spirit-val" style="color: gold;" id="sp-cost">25</span></div>
            <div class="spirit-row"><span>S·ªë ti·ªÅn/s (Ti·∫øp):</span><span class="spirit-val" id="sp-next-inc">2</span></div>
            <button class="close-btn" style="background:#28a745; color:#fff; width: 100%;" onclick="Game.confirmSpiritUpgrade()">N√ÇNG C·∫§P</button>
            <button class="close-btn" onclick="document.getElementById('spirit-ui').style.display='none'">ƒê√ìNG</button>
        </div>
    </div>

    <div id="mode-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-green);">
            <div id="mode-modal-title" class="modal-title" style="color: var(--n-green)">CH·∫æ ƒê·ªò</div>
            <div class="play-mode-card" style="border-color: var(--n-sky)" onclick="startGame('practice')">
                <div class="mode-title" style="color: var(--n-sky)">üåø Luy·ªán T√¢m C·∫£nh</div>
                <div class="mode-desc">Tƒ©nh t√¢m tu luy·ªán, kh√¥ng √°p l·ª±c t·ªëc ƒë·ªô.</div>
            </div>
            <div class="play-mode-card" style="border-color: var(--n-red)" onclick="startGame('battle')">
                <div class="mode-title" style="color: var(--n-red)">‚öîÔ∏è ƒê·∫•u Tr∆∞·ªùng</div>
                <div class="mode-desc">Th·ª≠ th√°ch anh h√πng, t·ªëc ƒë·ªô tƒÉng d·∫ßn.</div>
            </div>
            <button class="btn-large" style="width:100%; border:none; background:#222; color:#fff" onclick="closeCommonModal('mode-modal')">QUAY L·∫†I</button>
        </div>
    </div>

    <div id="msg-modal" class="modal">
        <div class="modal-box">
            <div id="msg-title" class="modal-title">TH√îNG B√ÅO</div>
            <div id="msg-body" class="modal-msg"></div>
            <button class="btn-large" style="width:100%; border:none; background:var(--n-blue); color:#000" onclick="closeCommonModal('msg-modal')">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-gold);">
            <div class="modal-title" style="color:var(--n-gold)">THI√äN SHOP NEON</div>
            <div style="max-height: 300px; overflow-y: auto;">
                <div class="shop-item" style="background: #111; border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ID Xanh L√°</span><button class="buy-btn" style="background:var(--n-blue); color:#000; border:none; padding: 8px 16px; border-radius:10px; font-weight:900" onclick="buyColor('#39ff14', 1000)">1000 LL</button>
                </div>
                <div class="shop-item" style="background: #111; border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ID V√†ng Neon</span><button class="buy-btn" style="background:var(--n-blue); color:#000; border:none; padding: 8px 16px; border-radius:10px; font-weight:900" onclick="buyColor('#fff200', 1000)">1000 LL</button>
                </div>
                <div class="shop-item" style="background: #111; border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ID T√≠m Neon</span><button class="buy-btn" style="background:var(--n-blue); color:#000; border:none; padding: 8px 16px; border-radius:10px; font-weight:900" onclick="buyColor('#bc13fe', 1500)">1500 LL</button>
                </div>
            </div>
            <button class="btn-large" style="width:100%; margin-top:15px; background:#222; color:#fff" onclick="closeCommonModal('shop-modal')">ƒê√ìNG</button>
        </div>
    </div>

    <div id="garden-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-green);">
            <div class="modal-title" style="color:var(--n-green)">V∆Ø·ªúN S·ªö & M√É L·ªÜNH</div>
            <div style="margin-bottom: 20px; border-bottom: 1px dashed #333; padding-bottom: 15px;">
                <input type="text" id="gift-code-input" style="width:100%; padding:10px; background:#111; border:1px solid var(--n-gold); color:var(--n-gold); border-radius:10px; text-align:center; box-sizing:border-box" placeholder="NH·∫¨P THI√äN M√É L·ªÜNH...">
                <button class="buy-btn" style="background:var(--n-gold); color:#000; border:none; padding: 8px 16px; border-radius:10px; font-weight:900; width:100%; height:35px; margin-top:8px; font-size:14px" onclick="useGiftCode()">K√çCH HO·∫†T M√É</button>
            </div>
            <textarea id="so-tau-text" style="width:100%; height:80px; background:#111; border:1px solid var(--n-green); color:#fff; border-radius:15px; padding:12px; margin-bottom:15px; box-sizing:border-box" placeholder="Nh·∫≠p t√¢m nguy·ªán..."></textarea>
            <button class="buy-btn" style="background:var(--n-green); color:#000; border:none; padding: 8px 16px; border-radius:10px; font-weight:900; width:100%; height:45px" onclick="guiSoTau()">G·ª¨I S·ªö (50 LL)</button>
            <button class="btn-large" style="width:100%; margin-top:10px; background:#222; color:#fff" onclick="closeCommonModal('garden-modal')">R·ªúI V∆Ø·ªúN</button>
        </div>
    </div>

    <div id="over-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-red);">
            <div class="modal-title" style="color:var(--n-red); font-size:38px">B·∫†I TR·∫¨N</div>
            <p id="over-score" style="font-size:26px; margin:15px 0; color:#fff; font-weight:900"></p>
            <button class="btn-retry" onclick="startGame(currentMode)">CH∆†I L·∫†I</button>
            <button class="btn-large" style="width:100%; margin-top:10px; border:2px solid var(--n-pink); color:var(--n-pink)" onclick="backToMenu()">V·ªÄ THI√äN ƒê√åNH</button>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-box" style="border-color: var(--n-purple);">
            <div class="modal-title" style="color:var(--n-purple)">THI√äN K√ù S·ª∞</div>
            <div id="history-content" style="text-align:left; font-size:14px; color:#ddd; max-height:250px; overflow-y:auto; padding:10px; background:#111; border-radius:15px"></div>
            <button class="btn-large" style="width:100%; margin-top:15px; background:#222; color:#fff" onclick="closeCommonModal('history-modal')">ƒê√ìNG</button>
        </div>
    </div>

    <canvas id="starCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-wrapper">
        <div id="top-bar">
            <div class="info-box">
                <div style="font-weight:900; font-size:24px; color:var(--n-gold)">ü¶ã <span id="ll-val">0</span></div>
                <div id="id-display" class="id-text">ID: ------</div>
            </div>
            <div id="music-toggle" onclick="openModal('music-modal')">üîä</div>
        </div>
        <div id="menu-center">
            <h1 id="rank-name">ƒê·ªíNG</h1>
            <button class="btn-start" onclick="openModal('gate-modal')">XU·∫§T TH·∫æ</button>
        </div>
        <div id="bottom-bar">
            <div class="btn-large btn-shop" onclick="openAndPlay('shop-modal', 'shop')">SHOP</div>
            <div class="btn-large btn-garden" onclick="openModal('garden-modal')">V∆Ø·ªúN S·ªö</div>
            <div class="btn-large btn-history" onclick="showHistory()">L·ªäCH S·ª¨</div>
            <div id="gift-btn" class="btn-large btn-gift" onclick="claimDailyGift()">QU√Ä 24H</div>
        </div>
    </div>

    <audio id="bg-music" src="nen7462.mp3" loop></audio>

<script>
    // FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAbqk7bAp7FFfB5RR_aHb0T-mBJNnm-Y0s",
      authDomain: "thegioianhsao-4f306.firebaseapp.com",
      databaseURL: "https://thegioianhsao-4f306-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "thegioianhsao-4f306",
      storageBucket: "thegioianhsao-4f306.firebasestorage.app",
      messagingSenderId: "257846252596",
      appId: "1:257846252596:web:14a2293cc8132a1807e661"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // GLOBAL VARS
    let data = null, musicOn = false, bgm = new Audio();
    let currentHomeSong = ''; 
    let failCount = 0;
    let savedBgmTime = 0; // L∆∞u th·ªùi gian nh·∫°c n·ªÅn

    const PRAISE = ["Thi√™n Gi·ªõi ghi nh·∫≠n b∆∞·ªõc ti·∫øn c·ªßa ng∆∞∆°i.", "Ng∆∞∆°i m·∫°nh h∆°n ch√≠nh m√¨nh l√∫c tr∆∞·ªõc.", "T√¢m ng∆∞∆°i v·ªØng, b∆∞·ªõc ch√¢n kh√¥ng lo·∫°n.", "Ng∆∞∆°i ƒë√£ l√†m r·∫•t t·ªët.", "S·ª± ti·∫øn b·ªô n√†y kh√¥ng h·ªÅ t·∫ßm th∆∞·ªùng."];
    const PROVOKE = ["Ng∆∞∆°i d·ª´ng l·∫°i ·ªü ƒë√¢y sao?", "Thi√™n Gi·ªõi tin r·∫±ng ng∆∞∆°i ch∆∞a ƒë·∫øn gi·ªõi h·∫°n.", "Th·ª≠ th√™m l·∫ßn n·ªØa xem sao.", "Gi·ªõi h·∫°n n√†y‚Ä¶ c√≥ th·∫≠t kh√¥ng?"];
    
    const songs = { 
        home: '', 
        jump_play: 'nhactrochoi.mp3', 
        flower_play: 'nen7462.mp3', 
        lose: 'thua895.mp3', 
        shop: 'nhacshop36.mp3', 
        history: 'lichsu5.mp3', 
        gift: 'nhanthuong639.mp3' 
    };

    // S·ª≠a: Ch·ªçn nh·∫°c v√† ƒë·ªïi m√†u n√∫t √¢m thanh
    function selectMusic(songSrc, elementId, type) {
        currentHomeSong = songSrc;
        musicOn = true;
        
        // Reset classes
        document.querySelectorAll('.music-item').forEach(item => {
            item.classList.remove('active-yellow', 'active-purple', 'active-pink');
        });

        const btnToggle = document.getElementById('music-toggle');
        
        if(type === 'gold') {
            document.getElementById(elementId).classList.add('active-yellow');
            btnToggle.style.borderColor = 'var(--n-gold)';
            btnToggle.style.color = 'var(--n-gold)';
            btnToggle.style.boxShadow = '0 0 15px var(--n-gold)';
        } else if(type === 'purple') {
            document.getElementById(elementId).classList.add('active-purple');
            btnToggle.style.borderColor = 'var(--n-purple-mid)';
            btnToggle.style.color = 'var(--n-purple-mid)';
            btnToggle.style.boxShadow = '0 0 15px var(--n-purple-mid)';
        } else if(type === 'pink') {
            document.getElementById(elementId).classList.add('active-pink');
            btnToggle.style.borderColor = 'var(--n-pink-mid)';
            btnToggle.style.color = 'var(--n-pink-mid)';
            btnToggle.style.boxShadow = '0 0 15px var(--n-pink-mid)';
        }

        playBGM('home');
    }

    // S·ª≠a: Logic ph√°t nh·∫°c h·ªó tr·ª£ resume
    function playBGM(t, resume = false) { 
        if(!musicOn) return; 
        
        let newSrc = (t === 'home') ? currentHomeSong : (songs[t] || currentHomeSong);
        if(!newSrc) return;

        // N·∫øu chuy·ªÉn b√†i ho√†n to√†n m·ªõi
        if(bgm.src.indexOf(encodeURI(newSrc)) === -1) {
            bgm.src = newSrc;
            bgm.currentTime = 0;
        }

        // N·∫øu l√† l·ªánh resume nh·∫°c n·ªÅn c≈©
        if(resume && t === 'home') {
            bgm.currentTime = savedBgmTime;
        }

        bgm.loop = true; 
        bgm.play().catch(()=>{}); 
    }

    // S·ª≠a: Khi v√†o shop t·∫°m d·ª´ng nh·∫°c n·ªÅn
    function openAndPlay(id, songKey) { 
        if(musicOn && !bgm.paused) {
            savedBgmTime = bgm.currentTime; // L∆∞u l·∫°i gi√¢y hi·ªán t·∫°i
        }
        openModal(id); 
        playBGM(songKey); 
    }

    // S·ª≠a: Khi ƒë√≥ng modal, n·∫øu l√† shop th√¨ resume nh·∫°c n·ªÅn
    function closeCommonModal(id) { 
        closeModal(id); 
        if(musicOn && !playing) {
            if(id === 'shop-modal') {
                playBGM('home', true); // Resume t·ª´ v·ªã tr√≠ c≈©
            } else {
                playBGM('home');
            }
        }
    }

    const gCan = document.getElementById('gameCanvas'), gCtx = gCan.getContext('2d');
    let playing = false, currentMode = 'battle', currentGame = 'jump';
    let p, camX, score, trail, plats, flowers, rainPetals, angle = 0, deathAlpha = 0, isDead = false;

    // LOGIC CƒÇN PH√íNG 13
    const room13BGM = document.getElementById('bg-music');
    const sounds = {
        lua: new Audio('banlua.mp3'), bang: new Audio('banbang.mp3'),
        tinhlinh: new Audio('bantinhlinh.mp3'), hoden: new Audio('banhoden.mp3'),
        gocua: new Audio('magocua.mp3'), thua: new Audio('tiengcuoma.mp3')
    };
    function playSfx(k) { const s = sounds[k]; if (s) { s.currentTime = 0; s.play().catch(e=>{}); } }

    let isDragging = false, startX, startY, panX = 0, panY = 0, moveDist = 0;
    const panContainer = document.getElementById('pan-container');
    window.addEventListener('pointerdown', e => { 
        if(currentGame !== 'room13') return;
        isDragging = true; startX = e.clientX - panX; startY = e.clientY - panY; moveDist = 0; 
    });
    window.addEventListener('pointermove', e => { 
        if (currentGame !== 'room13' || !isDragging) return; 
        panX = e.clientX - startX; panY = e.clientY - startY; 
        moveDist += Math.abs(e.movementX) + Math.abs(e.movementY); 
        panContainer.style.transform = `translate(${panX}px, ${panY}px)`; 
    });
    window.addEventListener('pointerup', () => isDragging = false);

    const Game = {
        coins: 50, prepTime: 30, doorHP: 100, doorMaxHP: 100, doorLvl: 1,
        monsterMaxHP: 600, monsterHP: 600, monsterLvl: 1,
        activeStaves: [], monster: null, isBattle: false,
        isMonsterRetreating: false, monsterDmgTaken: 0,
        monsterRage: false, usesBerserk: 0, maxBerserk: 5,
        usesEvilSpirit: 0, maxEvilSpirit: 3,
        stavesDisabled: false, isRegenerating: false, regenDuration: 0,
        spiritLvl: 1, spiritIncome: 1, gameLoopTimer: null, prepTimer: null,
        spiritData: [
            { cost: 0, inc: 1 }, { cost: 25, inc: 2 }, { cost: 50, inc: 4 }, { cost: 150, inc: 8 },
            { cost: 350, inc: 16 }, { cost: 500, inc: 32 }, { cost: 900, inc: 64 },
            { cost: 1500, inc: 128 }, { cost: 4500, inc: 256 }, { cost: 6500, inc: 512 }
        ],
        types: {
            lua: { aura: 'aura-lua', price: 16, dmg: 12, cd: 1500, bullet: 'bullet-lua' },
            bang: { aura: 'aura-bang', price: 16, dmg: 6, cd: 1500, bullet: 'bullet-bang' },
            tinhlinh: { aura: 'aura-tinhlinh', price: 26, dmg: 10, cd: 3500, bullet: 'bullet-tinhlinh' },
            hoden: { aura: 'aura-hoden', price: 26, dmg: 25, cd: 15000, bullet: 'bullet-hoden' }
        },
        resetGame() {
            if(this.monster) this.monster.remove();
            this.monster = null; clearInterval(this.gameLoopTimer); clearInterval(this.prepTimer);
            this.coins = 50; this.prepTime = 30; this.doorHP = 100; this.doorMaxHP = 100; this.doorLvl = 1;
            this.monsterMaxHP = 600; this.monsterHP = 600; this.monsterLvl = 1;
            this.activeStaves = []; this.isBattle = false; this.spiritLvl = 1; this.spiritIncome = 1;
            this.stavesDisabled = false;
            document.getElementById('coin-num').innerText = this.coins;
            document.getElementById('m-lvl-ui').innerText = "1";
            document.getElementById('door-lvl-ui').innerText = "1";
            document.getElementById('center-countdown').innerText = "30";
            document.getElementById('center-countdown').style.display = 'block';
            this.updateDoorUI();
        },
        init() {
            this.resetGame();
            const grid = document.getElementById("grid"); grid.innerHTML = "";
            for (let i = 0; i < 63; i++) {
                const tile = document.createElement("div"); tile.className = "tile";
                if (i === 31) {
                    tile.classList.add("occupied");
                    tile.innerHTML = `<div class="aura aura-cau"></div><img src="Cau44.png" class="spirit-img"><div class="lvl-tag" id="sp-tag">Lv1</div>`;
                    tile.onclick = () => { if(moveDist < 10) this.openSpiritUI(); };
                } else {
                    tile.innerText = "+";
                    tile.onclick = () => { if(moveDist < 10) this.handleTileClick(tile); };
                }
                grid.appendChild(tile);
            }
            this.prepTimer = setInterval(() => {
                this.prepTime--; document.getElementById('center-countdown').innerText = this.prepTime;
                if (this.prepTime <= 0) { clearInterval(this.prepTimer); document.getElementById('center-countdown').style.display = 'none'; this.startWave(); }
            }, 1000);
            this.gameLoopTimer = setInterval(() => {
                this.coins += this.spiritIncome; document.getElementById("coin-num").innerText = this.coins;
                if(this.isBattle) { this.combatLoop(); this.monsterAI(); this.monsterTactics(); }
            }, 1000);
        },
        monsterTactics() {
            if(!this.monster || this.isMonsterRetreating) return;
            const hpPct = this.monsterHP / this.monsterMaxHP;
            if (hpPct < 0.50 && !this.isRegenerating) { this.isRegenerating = true; this.regenDuration = 10; this.showSkillText("H·ªíI M√ÅU!"); }
            if (this.isRegenerating) {
                this.monsterHP = Math.min(this.monsterMaxHP, this.monsterHP + (this.monsterMaxHP * 0.05));
                this.updateMonsterHPUI(); this.regenDuration--; if(this.regenDuration <= 0) this.isRegenerating = false;
            }
            if (!this.stavesDisabled && this.usesEvilSpirit < this.maxEvilSpirit && hpPct < 0.6) this.activateEvilSpirit();
            if (!this.monsterRage && this.usesBerserk < this.maxBerserk && hpPct < 0.4) this.activateBerserk();
        },
        activateEvilSpirit() {
            this.usesEvilSpirit++; this.stavesDisabled = true; this.showSkillText("LINH √ÅC MA!");
            if(this.monster) this.monster.querySelector('img').classList.add('evil-mode');
            setTimeout(() => { this.stavesDisabled = false; if(this.monster) this.monster.querySelector('img').classList.remove('evil-mode'); }, 5000);
        },
        activateBerserk() {
            this.usesBerserk++; this.monsterRage = true;
            this.monsterHP = Math.min(this.monsterMaxHP, this.monsterHP + (this.monsterMaxHP * 0.5));
            this.updateMonsterHPUI(); this.showSkillText("CU·ªíNG B·∫†O!");
            if(this.monster) this.monster.classList.add('rage-mode');
        },
        showSkillText(txt) {
            if(!this.monster) return;
            const noti = document.createElement('div'); noti.className = 'skill-notify'; noti.innerText = txt;
            this.monster.appendChild(noti); setTimeout(() => noti.remove(), 1000);
        },
        openSpiritUI() {
            const sl = this.spiritLvl; const nextData = (sl < 10) ? this.spiritData[sl] : null;
            document.getElementById('sp-lvl').innerText = sl; document.getElementById('sp-inc').innerText = this.spiritIncome;
            document.getElementById('sp-cost').innerText = nextData ? nextData.cost : "MAX";
            document.getElementById('sp-next-inc').innerText = nextData ? nextData.inc : "MAX";
            document.getElementById('spirit-ui').style.display = 'flex';
        },
        confirmSpiritUpgrade() {
            if (this.spiritLvl >= 10) return;
            const nextData = this.spiritData[this.spiritLvl];
            if (this.coins >= nextData.cost) {
                this.coins -= nextData.cost; this.spiritLvl++; this.spiritIncome = nextData.inc;
                document.getElementById('sp-tag').innerText = "Lv" + this.spiritLvl; this.openSpiritUI();
            }
        },
        handleTileClick(tile) {
            if (!tile.classList.contains('occupied')) { this.targetTile = tile; document.getElementById("shop-ui").style.display = "flex"; } 
            else { const staff = this.activeStaves.find(s => s.tile === tile); if (staff) this.openUpgrade(staff); }
        },
        closeShop() { document.getElementById("shop-ui").style.display = "none"; },
        buy(typeKey) {
            const cfg = this.types[typeKey];
            if (this.coins >= cfg.price) {
                this.coins -= cfg.price; const tile = this.targetTile; tile.classList.add("occupied");
                tile.innerHTML = `<div class="aura ${cfg.aura}"></div><img src="${this.getImg(typeKey)}" class="item-img"><div class="lvl-tag">Lv1</div>`;
                this.activeStaves.push({ tile, type: typeKey, lvl: 1, dmg: cfg.dmg, cd: cfg.cd, lastShot: 0, currPrice: cfg.price });
                this.closeShop();
            }
        },
        getImg(t) { if(t=='lua') return 'Lua68.png'; if(t=='bang') return 'Ban44.png'; if(t=='tinhlinh') return 'Cay.png'; return 'Hoden.png'; },
        openUpgrade(staff) {
            this.targetUpgrade = staff; const nextPrice = Math.floor(staff.currPrice * 1.5);
            document.getElementById('up-curr-lvl').innerText = staff.lvl; document.getElementById('up-next-lvl').innerText = staff.lvl + 1;
            document.getElementById('up-price').innerText = nextPrice; document.getElementById('upgrade-ui').style.display = 'flex';
        },
        confirmUpgrade() {
            const s = this.targetUpgrade; const nextPrice = Math.floor(s.currPrice * 1.5);
            if (this.coins >= nextPrice) {
                this.coins -= nextPrice; s.lvl++; s.currPrice = nextPrice; s.dmg = Math.floor(s.dmg * 1.5); 
                s.tile.querySelector('.lvl-tag').innerText = "Lv" + s.lvl; document.getElementById('upgrade-ui').style.display = 'none';
            }
        },
        getDoorUpgradePrice() {
            if (this.doorLvl === 1) return 16;
            if (this.doorLvl === 2) return 24;
            let price = 35; for(let i=3; i<this.doorLvl; i++) price = Math.floor(price * 1.5);
            return price;
        },
        openDoorUpgrade() {
            document.getElementById('door-curr-lvl').innerText = this.doorLvl;
            document.getElementById('door-up-price').innerText = this.getDoorUpgradePrice();
            document.getElementById('door-upgrade-ui').style.display = 'flex';
        },
        confirmDoorUpgrade() {
            const price = this.getDoorUpgradePrice();
            if (this.coins >= price) {
                this.coins -= price; this.doorLvl++; this.doorMaxHP += 200; this.doorHP = this.doorMaxHP; 
                document.getElementById('door-lvl-ui').innerText = this.doorLvl; this.updateDoorUI();
                document.getElementById('door-upgrade-ui').style.display = 'none';
            }
        },
        startWave() {
            this.isBattle = true; const m = document.createElement('div'); m.className = 'monster';
            m.innerHTML = `<div class="m-lvl-tag">Lv <span id="m-lvl-val">1</span></div><div class="m-hp-bar"><div id="m-hp" class="m-hp-fill"></div></div><img src="Manu.png">`;
            document.getElementById('room-wrapper').appendChild(m); this.monster = m;
        },
        monsterAI() {
            if (!this.monster) return;
            if (!this.isMonsterRetreating) {
                this.monster.style.top = "-80px"; this.monster.style.opacity = "1";
                let dmg = 6 * (1 + (this.monsterLvl * 0.1)); if (this.monsterRage) dmg *= 2; 
                this.doorHP -= dmg; this.updateDoorUI(); playSfx('gocua');
                const room = document.getElementById('room-wrapper');
                room.classList.remove("shake-active"); void room.offsetWidth; room.classList.add("shake-active");
                if (this.doorHP <= 0) { playSfx('thua'); setTimeout(() => { alert("TH·∫§T B·∫†I!"); this.init(); }, 500); }
                if (this.monsterHP <= this.monsterMaxHP * 0.27) { this.isMonsterRetreating = true; this.monsterRage = false; if(this.monster) this.monster.classList.remove('rage-mode'); }
            } else {
                this.monster.style.top = "-260px"; this.monster.style.opacity = "0"; 
                this.monsterHP += (this.monsterMaxHP * 0.04); if (this.monsterHP >= this.monsterMaxHP) { this.monsterHP = this.monsterMaxHP; this.isMonsterRetreating = false; }
                this.updateMonsterHPUI();
            }
        },
        updateDoorUI() { document.getElementById('door-hp').style.width = Math.max(0, (this.doorHP / this.doorMaxHP) * 100) + "%"; },
        updateMonsterHPUI() { if(this.monster) document.getElementById('m-hp').style.width = Math.max(0, (this.monsterHP / this.monsterMaxHP) * 100) + "%"; },
        combatLoop() {
            if (!this.monster || this.isMonsterRetreating || this.stavesDisabled) return;
            let now = Date.now();
            this.activeStaves.forEach(s => { if (now - s.lastShot > s.cd) { this.fire(s); s.lastShot = now; } });
        },
        fire(s) {
            playSfx(s.type); const b = document.createElement('div');
            b.className = `bullet ${this.types[s.type].bullet}`;
            b.style.left = (s.tile.offsetLeft + 10) + 'px'; b.style.top = (s.tile.offsetTop + 10) + 'px';
            document.getElementById('room-wrapper').appendChild(b);
            setTimeout(() => {
                b.style.left = '185px'; b.style.top = '-80px';
                setTimeout(() => {
                    b.remove();
                    if (this.monster && !this.isMonsterRetreating) {
                        this.monsterHP -= s.dmg; this.updateMonsterHPUI();
                        this.monsterDmgTaken += (s.dmg * 5); this.checkMonsterLevel();
                    }
                }, 400);
            }, 50);
        },
        checkMonsterLevel() {
            if (this.monsterDmgTaken >= (800 * this.monsterLvl)) {
                this.monsterLvl++; this.monsterDmgTaken = 0; this.monsterMaxHP *= 1.25;
                this.monsterHP = Math.min(this.monsterMaxHP, this.monsterHP + (this.monsterMaxHP * 0.2));
                document.getElementById('m-lvl-ui').innerText = this.monsterLvl;
                document.getElementById('m-lvl-val').innerText = this.monsterLvl; this.showSkillText("L√äN C·∫§P!");
            }
        }
    };

    function chooseGame(gameType) {
        currentGame = gameType;
        closeModal('gate-modal');
        bgm.pause(); 
        if (gameType === 'room13') {
            document.getElementById('ui-wrapper').style.display = 'none';
            document.getElementById('room13-container').style.display = 'block';
            if (musicOn) room13BGM.play();
            Game.init();
        } else {
            document.getElementById('mode-modal-title').innerText = (gameType === 'jump' ? 'NH·∫¢Y B·ª§C' : 'LINH ·∫¢NH');
            openModal('mode-modal');
        }
    }

    function backToMenuFromRoom() {
        Game.resetGame();
        document.getElementById('room13-container').style.display = 'none';
        document.getElementById('ui-wrapper').style.display = 'flex';
        room13BGM.pause();
        room13BGM.currentTime = 0;
        if (musicOn) playBGM('home');
    }

    function listenToAdmin() {
        if(!data) return;
        db.ref("AdminCommands/Bonus").on("value", (snap) => {
            const cmd = snap.val();
            if(cmd && cmd.timestamp > (data.lastBonusTime || 0)) {
                if(cmd.target === "ALL" || cmd.target == data.uid || cmd.target === data.username) {
                    data.ll += parseInt(cmd.value); data.lastBonusTime = cmd.timestamp;
                    addHistory(`Nh·∫≠n ban th∆∞·ªüng t·ª´ Admin: +${cmd.value} LL`);
                    updateUI(); save(); showPopup("THI√äN L·ªòC", `Ng√†i v·ª´a ƒë∆∞·ª£c Admin ban t·∫∑ng ${cmd.value} Linh L∆∞·ª£ng!`, 'var(--n-gold)');
                    playBGM('gift');
                }
            }
        });
    }

    function addHistory(msg) {
        if(!data) return;
        const now = new Date(); const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} - ${now.getDate()}/${now.getMonth() + 1}`;
        if(!data.history) data.history = []; data.history.push({ time: timeStr, text: msg });
        if(data.history.length > 20) data.history.shift(); save();
    }

    function useGiftCode() {
        const input = document.getElementById('gift-code-input').value.trim().toUpperCase();
        if(!input) return;
        db.ref("ServerSettings").once("value", (snap) => {
            const settings = snap.val() || {};
            const hardCodes = { "THIENGIOI": 500, "TANTHU": 1000, "LINHANH": 2000 };
            let reward = 0;
            if(input === settings.activeCode) reward = settings.rewardAmount;
            else if(hardCodes[input]) reward = hardCodes[input];
            if(!data.usedCodes) data.usedCodes = {};
            if(data.usedCodes[input]) { showPopup("TH·∫§T B·∫†I", "M√£ l·ªánh n√†y ng∆∞∆°i ƒë√£ d√πng r·ªìi!"); return; }
            if(reward > 0) {
                data.ll += reward; data.usedCodes[input] = true;
                addHistory(`S·ª≠ d·ª•ng m√£ l·ªánh ${input}: +${reward} LL`);
                updateUI(); save(); playBGM('gift');
                showPopup("K√çCH HO·∫†T", `Nh·∫≠n th√†nh c√¥ng ${reward} Linh L∆∞·ª£ng!`, 'var(--n-gold)');
                document.getElementById('gift-code-input').value = "";
            } else { showPopup("SAI M√É", "M√£ l·ªánh kh√¥ng t·ªìn t·∫°i tr√™n Thi√™n ƒê√¨nh."); }
        });
    }

    function showHistory() {
        if(!data) return;
        const content = document.getElementById('history-content');
        content.innerHTML = (data.history || []).map(h => `
            <div style="margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px">
                <span style="color:var(--n-gold); font-size:12px">[${h.time}]</span><br>${h.text}
            </div>
        `).reverse().join('') || "<p style='text-align:center'>Ch∆∞a c√≥ k√Ω s·ª±.</p>";
        openAndPlay('history-modal', 'history');
    }

    function claimDailyGift() {
        if(!data) return;
        const now = Date.now();
        if(now - (data.lastDaily || 0) < 86400000) { showPopup("CH∆ØA ƒê·∫æN GI·ªú", "Thi√™n ƒê√¨nh ban qu√† m·ªói 24 gi·ªù."); return; }
        const reward = Math.floor(Math.random() * 401) + 100;
        data.ll += reward; data.lastDaily = now; addHistory(`Nh·∫≠n qu√† 24H: +${reward} Linh L∆∞·ª£ng.`);
        updateUI(); save(); playBGM('gift');
        showPopup("THI√äN L·ªòC", `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${reward} Linh L∆∞·ª£ng!`, 'var(--n-pink)');
    }

    function startGame(m) {
        currentMode = m;
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('ui-wrapper').style.display = 'none';
        gCan.style.display = 'block';
        playing = true; isDead = false; deathAlpha = 0; camX = 0; score = 0; trail = []; angle = 0;
        gCan.width = window.innerWidth; gCan.height = window.innerHeight;
        p = { x: (currentGame === 'jump' ? 80 : 100), y: gCan.height / 2, dy: 0, s: 35 };

        if (currentGame === 'jump') {
            plats = [{x:0, y:gCan.height-130, w:gCan.width}];
            for(let i=0; i<500; i++) plats.push({x: i*450+450, y: gCan.height-(150+Math.random()*180), w: 220});
            playBGM('jump_play');
        } else if (currentGame === 'flower') {
            flowers = []; rainPetals = [];
            for(let i=0; i<65; i++) rainPetals.push({x: Math.random()*gCan.width, y: Math.random()*gCan.height, s: Math.random()*6+4, speed: Math.random()*1.4+0.8, angle: Math.random()*Math.PI*2, rotSpeed: Math.random()*0.05-0.025, swing: Math.random()*2+1, flip: Math.random()*Math.PI});
            for(let i=0; i<600; i++) flowers.push({x: i*460+600+(Math.random()*300-150), y: Math.random()*(gCan.height-120)+60, size: Math.random()<0.7?30:(Math.random()<0.9?55:90), opacity: 0.85});
            playBGM('flower_play');
        }
        loop();
    }

    function loop() {
        if(!playing && deathAlpha === 0) return;
        gCtx.clearRect(0,0,gCan.width, gCan.height);
        if (currentGame === 'jump') {
            let speed = currentMode === 'practice' ? 6.5 : 8.5 + (score * 0.05);
            camX += speed; p.dy += 1.4; p.y += p.dy;
            gCtx.save(); gCtx.translate(-camX, 0);
            plats.forEach(pl => {
                gCtx.fillStyle = '#39ff14'; gCtx.fillRect(pl.x, pl.y, pl.w, 35);
                if(p.dy >= 0 && p.x+camX+p.s > pl.x && p.x+camX < pl.x+pl.w && p.y+p.s >= pl.y && p.y+p.s <= pl.y+35) { p.y = pl.y - p.s; p.dy = 0; if(!pl.passed) { pl.passed = true; score++; } }
            });
            trail.push({x: p.x+camX, y: p.y, h: (Date.now()/5)%360}); if(trail.length > 15) trail.shift();
            trail.forEach((t,i) => { gCtx.globalAlpha = i/15*0.5; gCtx.fillStyle = `hsl(${t.h},100%,50%)`; gCtx.fillRect(t.x, t.y, p.s, p.s); });
            gCtx.globalAlpha = 1; gCtx.fillStyle = "#fff"; gCtx.fillRect(p.x+camX, p.y, p.s, p.s);
            gCtx.restore(); if(p.y > gCan.height) gameOver();
        } else if (currentGame === 'flower') {
            if (isDead) { deathAlpha += 0.0085; if (deathAlpha > 1) deathAlpha = 1; }
            rainPetals.forEach(rp => {
                if(!isDead) {
                    rp.y += rp.speed; rp.x += Math.sin(rp.y / 70) * rp.swing; rp.angle += rp.rotSpeed; rp.flip += 0.04;
                    if(rp.y > gCan.height + 20) { rp.y = -20; rp.x = Math.random() * gCan.width; }
                }
                gCtx.save(); gCtx.translate(rp.x, rp.y); gCtx.rotate(rp.angle); gCtx.scale(1, Math.sin(rp.flip));
                gCtx.fillStyle = `rgba(255, 160, 190, ${0.8 * (1 - deathAlpha)})`;
                gCtx.beginPath(); gCtx.ellipse(0, 0, rp.s, rp.s/1.4, 0, 0, Math.PI * 2); gCtx.fill(); gCtx.restore();
            });
            if (!isDead) {
                let speed = currentMode === 'practice' ? 4.6 : 4.6 + (score * 0.02);
                p.dy += 0.39; p.y += p.dy; camX += speed; angle += 0.02;
                if(p.y > gCan.height + 100 || p.y < -100) gameOver();
            }
            trail.push({x: p.x, y: p.y}); if(trail.length > 25) trail.shift();
            trail.forEach((t, i) => {
                let ratio = i / trail.length; gCtx.fillStyle = `rgba(180, 100, 255, ${ratio * 0.35 * (1 - deathAlpha)})`; 
                let s = p.s * (0.5 + 0.5 * ratio); gCtx.fillRect(t.x + (p.s-s)/2, t.y + (p.s-s)/2, s, s);
            });
            gCtx.save(); gCtx.translate(-camX, 0);
            flowers.forEach(f => {
                if(f.x > camX - 150 && f.x < camX + gCan.width + 150) {
                    drawDetailedFlower(f);
                    if (!isDead) {
                        let dx = (p.x + camX + p.s/2) - f.x; let dy = (p.y + p.s/2) - f.y;
                        if(Math.sqrt(dx*dx + dy*dy) < f.size * 0.8) { score = Math.floor(camX/100); gameOver(); }
                    }
                }
            });
            gCtx.restore();
            gCtx.save(); gCtx.fillStyle = `rgba(255, 255, 255, ${1 - deathAlpha})`;
            gCtx.shadowBlur = 10; gCtx.shadowColor = "white"; gCtx.fillRect(p.x, p.y, p.s, p.s); gCtx.restore();
            if (deathAlpha > 0) { gCtx.fillStyle = `rgba(0, 0, 0, ${deathAlpha})`; gCtx.fillRect(0, 0, gCan.width, gCan.height); gCan.style.filter = `blur(${deathAlpha * 15}px)`; } else { gCan.style.filter = `none`; }
        }
        if(!isDead && currentGame !== 'flower') {
            gCtx.fillStyle = "#fff200"; gCtx.font = "900 45px 'Segoe UI'"; gCtx.fillText("SCORE: " + score, 25, 60);
        }
        if(playing || deathAlpha > 0) requestAnimationFrame(loop);
    }

    function gameOver() {
        if(isDead) return; isDead = true; playing = false; failCount++;
        addHistory(`K·∫øt th√∫c m√†n ${currentGame === 'jump' ? 'Nh·∫£y B·ª•c' : 'Linh ·∫¢nh'}. ƒêi·ªÉm: ${score}`);
        setTimeout(() => showFinalOver(), currentGame === 'flower' ? 3000 : 0);
    }

    function showFinalOver() {
        let msg = (score >= (data.bestScore || 0) * 0.9) ? PROVOKE[Math.floor(Math.random()*PROVOKE.length)] : PRAISE[Math.floor(Math.random()*PRAISE.length)];
        showCelestialMessage(msg); if(score > (data.bestScore || 0)) { data.bestScore = score; save(); }
        playBGM('lose'); document.getElementById('over-score').innerText = "C√îNG L·ª∞C: " + score; openModal('over-modal');
    }

    function drawDetailedFlower(f) {
        gCtx.save(); gCtx.translate(f.x, f.y); gCtx.rotate(angle * 0.5);
        for (let i = 0; i < 5; i++) {
            gCtx.save(); gCtx.rotate((Math.PI * 2 / 5) * i); gCtx.beginPath(); gCtx.moveTo(0, 0);
            gCtx.bezierCurveTo(-f.size/2, f.size/2, -f.size, f.size, 0, f.size * 1.2);
            gCtx.bezierCurveTo(f.size, f.size, f.size/2, f.size/2, 0, 0);
            let g = gCtx.createRadialGradient(0, f.size/2, 0, 0, f.size/2, f.size);
            g.addColorStop(0, `rgba(255, 51, 153, ${f.opacity})`); g.addColorStop(1, `rgba(255, 100, 180, 0)`);
            gCtx.fillStyle = g; gCtx.fill(); gCtx.restore();
        }
        gCtx.fillStyle = `rgba(255, 190, 0, ${f.opacity})`; gCtx.beginPath(); gCtx.arc(0, 0, f.size/5, 0, Math.PI * 2); gCtx.fill(); gCtx.restore();
    }

    function toggleMusic() { 
        musicOn = !musicOn; 
        document.getElementById('music-toggle').classList.toggle('on', musicOn); 
        if(musicOn) playBGM('home'); else bgm.pause(); 
    }

    function handleAuth() {
        const user = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if(user.length < 3) return;
        db.ref("Players/" + user).once("value", (snap) => {
            if(snap.val()) {
                if(snap.val().password === pass) { data = snap.val(); loginSuccess(); }
                else showPopup("L·ªñI", "M·∫≠t m√£ kh√¥ng ƒë√∫ng!", 'var(--n-red)');
            } else {
                data = { username: user, password: pass, uid: Math.floor(100000+Math.random()*899999), ll: 500, lastDaily: 0, idColor: '#ff00ff', history: [], bestScore: 0, usedCodes: {} };
                db.ref("Players/" + user).set(data); loginSuccess();
            }
        });
    }

    function loginSuccess() { 
        localStorage.setItem('current_user', data.username); 
        document.getElementById('login-screen').style.display = 'none'; 
        document.getElementById('ui-wrapper').style.display = 'flex'; 
        updateUI(); listenToAdmin();
    }

    function updateUI() { 
        if(!data) return; 
        document.getElementById('ll-val').innerText = data.ll; 
        const idDisp = document.getElementById('id-display'); idDisp.innerText = "ID: " + data.uid; idDisp.style.color = data.idColor || 'var(--n-pink)'; 
        document.getElementById('rank-name').innerText = data.ll > 5000 ? "V√ÄNG" : (data.ll > 2000 ? "B·∫†C" : "ƒê·ªíNG"); 
    }

    function save() { if(data) db.ref("Players/" + data.username).update(data); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function backToMenu() { closeModal('over-modal'); gCan.style.display = 'none'; document.getElementById('ui-wrapper').style.display = 'flex'; playBGM('home'); }
    function buyColor(color, price) { if(data.ll >= price) { data.ll -= price; data.idColor = color; addHistory(`Mua m√†u ID: ${color}`); updateUI(); save(); showPopup("TH√ÄNH C√îNG", "ƒê√£ ƒë·ªïi h√†o quang ID."); } else showPopup("THI·∫æU LL", "Ng∆∞∆°i c·∫ßn th√™m Linh L∆∞·ª£ng."); }
    function guiSoTau() { const txt = document.getElementById('so-tau-text').value.trim(); if(txt.length > 5 && data.ll >= 50) { data.ll -= 50; addHistory(`G·ª≠i s·ªõ: ${txt}`); document.getElementById('so-tau-text').value = ""; updateUI(); save(); showPopup("GHI NH·∫¨N", "T√¢m nguy·ªán ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n Thi√™n ƒê√¨nh."); } }
    
    window.onpointerdown = (e) => { 
        if(!playing || isDead || currentGame === 'room13') return; 
        e.preventDefault(); 
        if(currentGame === 'jump') { if(p.dy === 0) p.dy = -28; } else { p.dy = -7.6; } 
    };

    const sCan = document.getElementById('starCanvas'), sCtx = sCan.getContext('2d');
    let stars = [];
    function initS() {
        sCan.width = window.innerWidth; sCan.height = window.innerHeight;
        stars = Array.from({length: 800}, () => ({x: Math.random()*sCan.width, y: Math.random()*sCan.height, s: Math.random()*2, v: Math.random()*0.5, c: ['#00f3ff','#ff00ff','#39ff14','#fff200','#fff'][Math.floor(Math.random()*5)]}));
    }
    function drawS() {
        sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sCan.width, sCan.height);
        if (!(playing && currentGame === 'flower')) {
            stars.forEach(s => { sCtx.fillStyle = s.c; sCtx.fillRect(s.x, s.y, s.s, s.s); s.y += s.v; if(s.y > sCan.height) s.y = -5; });
        }
        requestAnimationFrame(drawS);
    }
    initS(); drawS();

    function showPopup(title, body, color = 'var(--n-blue)') { document.getElementById('msg-title').innerText = title; document.getElementById('msg-title').style.color = color; document.getElementById('msg-body').innerText = body; openModal('msg-modal'); }
    function showCelestialMessage(msg) { const old = document.getElementById('celestial-msg'); if(old) old.remove(); const div = document.createElement('div'); div.id = 'celestial-msg'; div.innerText = msg; document.body.appendChild(div); }
    
    const saved = localStorage.getItem('current_user');
    if(saved) db.ref("Players/" + saved).once("value", s => { if(s.val()){ data = s.val(); loginSuccess(); }});
</script>
</body>
</html>
